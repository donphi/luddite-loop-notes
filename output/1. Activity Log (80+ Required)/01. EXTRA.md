# EXTRA


## Content


```markdown
# Pass 8: Single Sentence vs. Context Window - Critical Decision

**Answer: You need BOTH - a hybrid approach is essential for discovery signals**

## Why Context Windows are Critical for Discovery Signals

### Single Sentence Limitations

```python
# Example of why single sentences fail:
sentence_1 = "We observed significant comorbidity between tobacco use (34.2%) and alcohol use disorders (OR=2.3, p<0.001)."
sentence_2 = "This association was not further analyzed."
sentence_3 = "Our primary focus was genetic variants in nicotine metabolism."

# Single sentence extraction would miss:
# - "This association" refers to tobacco-alcohol link
# - The contrast between what was found vs studied
# - The research priority mismatch
```

## Recommended Hybrid Architecture

### Stage 1: Single Sentence Tagging (Basic Signals)

```python
class SingleSentenceExtractor:
    """Extract what's possible from single sentences"""
    
    def extract_discovery_signals(self, sentence):
        signals = {
            'causal_language': self.detect_causal_verbs(sentence),
            'statistical_strength': self.assess_statistics(sentence),
            'unexpected_keywords': self.detect_surprise_words(sentence),
            # These are PARTIAL and need context:
            'mentioned_not_studied_hint': self.detect_not_studied_pattern(sentence),
            'potential_comorbidity': self.detect_comorbidity_mention(sentence)
        }
        return signals
```

### Stage 2: Context Window Analysis (Critical for Discovery)

```python
class ContextWindowAnalyzer:
    """3-5 sentence windows for discovery signals"""
    
    def analyze_discovery_potential(self, sentences, target_idx):
        # Get context window (2 before, 2 after)
        window = sentences[max(0, target_idx-2):min(len(sentences), target_idx+3)]
        
        discovery_signals = {
            'hidden_comorbidity': False,
            'mentioned_not_studied': False,
            'research_gap': False,
            'discovery_score': 0.0
        }
        
        # Pattern 1: Finding → Not Studied
        if self.detect_finding_not_studied_pattern(window):
            discovery_signals['mentioned_not_studied'] = True
            discovery_signals['discovery_score'] += 3.0
        
        # Pattern 2: Unexpected comorbidity
        if self.detect_unexpected_comorbidity(window):
            discovery_signals['hidden_comorbidity'] = True
            discovery_signals['discovery_score'] += 2.5
        
        # Pattern 3: Cross-domain surprise
        if self.detect_cross_domain_connection(window):
            discovery_signals['cross_domain_connection'] = True
            discovery_signals['discovery_score'] += 2.0
        
        return discovery_signals
```

## Specific Patterns That REQUIRE Context

### 1. "Mentioned Not Studied" Pattern

```python
def detect_mentioned_not_studied_pattern(window):
    """
    Requires 2-3 sentences to detect:
    [FINDING] + [NOT STUDIED] + [WHAT WAS STUDIED INSTEAD]
    """
    patterns = [
        # Pattern A: Direct statement across sentences
        (r"observed|found|detected|identified", 
         r"not (further |)analyzed|beyond.*scope|not investigated|did not examine"),
        
        # Pattern B: Incidental finding
        (r"incidentally|additionally|also observed|interestingly",
         r"however|but|although|primary focus|main analysis"),
        
        # Pattern C: Exclusion after observation
        (r"significant|associated|correlated",
         r"excluded from|removed from|not included in")
    ]
    
    # Need to match across sentence boundaries
    for i, sent in enumerate(window[:-1]):
        if matches_pattern(sent, patterns[0]):
            if matches_pattern(window[i+1], patterns[1]):
                return True
```

### 2. Hidden Comorbidity Detection

```python
def detect_hidden_comorbidity(window):
    """
    Needs context to distinguish:
    - Is this the main finding or incidental?
    - Was it studied elsewhere in the paper?
    - How surprising is the co-occurrence?
    """
    
    # Check if diseases co-occur
    diseases_mentioned = extract_diseases(window)
    if len(diseases_mentioned) < 2:
        return False
    
    # Check if it's NOT the primary focus
    primary_focus = extract_primary_focus(window)
    if all(d in primary_focus for d in diseases_mentioned):
        return False  # It's actually being studied
    
    # Check for surprise indicators
    surprise_score = calculate_surprise(window)
    # "unexpectedly", "surprisingly", "notably", "interestingly"
    
    # Check for high statistical association but low attention
    stats_strength = extract_statistics(window)
    attention_markers = count_attention_markers(window)
    # High stats + low attention = hidden finding
    
    return surprise_score > 0.5 or (stats_strength > 0.7 and attention_markers < 2)
```

### 3. Research Gap Identification

```python
def identify_research_gaps(window):
    """
    Requires understanding:
    - What was measured/observed
    - What was analyzed
    - What was recommended for future
    """
    
    gaps = {
        'observed_not_analyzed': [],
        'mentioned_future_work': [],
        'limitations_mentioned': [],
        'cross_domain_opportunity': []
    }
    
    # Parse the narrative flow
    observations = extract_observations(window)
    analyses = extract_analyses(window)
    future = extract_future_directions(window)
    
    # Gaps = observations - analyses
    gaps['observed_not_analyzed'] = set(observations) - set(analyses)
    
    # Explicit future work
    if "future studies" in ' '.join(window).lower():
        gaps['mentioned_future_work'] = extract_future_topics(window)
    
    return gaps
```

## Optimal Window Sizes for Different Signals

```python
OPTIMAL_WINDOWS = {
    'mentioned_not_studied': 3,      # Finding + not studied + context
    'hidden_comorbidity': 5,         # Full finding description
    'research_gap': 7,               # Methods → results → limitations
    'contradiction': 3,              # Statement + contradiction
    'cross_domain_connection': 5,    # Multiple domains mentioned
    'causal_chain': 7,              # Full causal reasoning
    'drug_repurposing': 5,          # Disease + drug + mechanism
}
```

## Implementation Strategy

### Phase 1: Initial Single-Sentence Tagging
```python
# First pass - get everything you can from single sentences
for sentence in sentences:
    base_extraction = extract_single_sentence(sentence)
    save_to_db(base_extraction)
```

### Phase 2: Context-Aware Discovery Enhancement
```python
# Second pass - enhance with context windows
for doc_id in documents:
    sentences = get_sentences(doc_id)
    
    for i, sentence in enumerate(sentences):
        # Get existing single-sentence extraction
        base = get_extraction(sentence.id)
        
        # Enhance with context
        for signal_type, window_size in OPTIMAL_WINDOWS.items():
            window = get_window(sentences, i, window_size)
            signal_value = analyze_signal(signal_type, window, target_idx=i)
            
            # Update the sentence record
            base['discovery_signals'][signal_type] = signal_value
        
        # Recalculate discovery score with context
        base['discovery_signals']['discovery_score'] = calculate_final_score(base)
        update_db(base)
```

### Phase 3: Paragraph-Level Aggregation
```python
# Third pass - paragraph-level patterns
for paragraph in paragraphs:
    sentences = get_paragraph_sentences(paragraph)
    
    # Some patterns only visible at paragraph level
    paragraph_signals = {
        'builds_unexpected_connection': detect_paragraph_bridge(sentences),
        'research_pivot': detect_research_pivot(sentences),
        'buried_finding': detect_buried_finding(sentences)
    }
    
    # Propagate back to sentences
    for sentence in sentences:
        update_sentence_with_paragraph_context(sentence, paragraph_signals)
```

## LLM Prompting Strategy for Context Windows

```python
def generate_discovery_prompt(window, target_idx):
    """Create prompt for LLM discovery analysis"""
    
    prompt = f"""
    Analyze this research text for hidden discoveries and unstudied findings.
    
    CONTEXT (5 sentences):
    {format_with_numbers(window)}
    
    FOCUS SENTENCE (#{target_idx + 1}):
    {window[target_idx]}
    
    EXTRACTED ENTITIES:
    Diseases: {extract_diseases(window[target_idx])}
    Statistics: {extract_stats(window[target_idx])}
    
    QUESTIONS:
    1. Is the finding in the focus sentence the primary research objective? (Y/N)
    2. Is this finding further analyzed in the context? (Y/N)
    3. Does this represent a missed research opportunity? (Y/N)
    4. How surprising is this finding given the context? (0-10)
    5. What's the discovery potential? (0-10)
    
    LOOK FOR:
    - High statistical associations that are dismissed
    - Comorbidities mentioned but not explored
    - "We observed X but did not investigate"
    - Findings in exclusion criteria or baseline tables
    - Cross-domain connections not pursued
    
    OUTPUT JSON:
    {{
        "mentioned_not_studied": boolean,
        "hidden_comorbidity": boolean,
        "discovery_score": float,
        "reasoning": "explanation",
        "research_opportunity": "description if found"
    }}
    """
    
    return prompt
```

## Database Schema Addition for Context

```sql
-- Add context tracking to your schema
ALTER TABLE sentence_vectors ADD COLUMN context_window_analyzed BOOLEAN DEFAULT FALSE;
ALTER TABLE sentence_vectors ADD COLUMN context_window_size INT;
ALTER TABLE sentence_vectors ADD COLUMN paragraph_signals JSONB;
ALTER TABLE sentence_vectors ADD COLUMN discovery_confidence_before_context DOUBLE;
ALTER TABLE sentence_vectors ADD COLUMN discovery_confidence_after_context DOUBLE;

-- Track which sentences influenced discovery signals
CREATE TABLE discovery_context (
    sentence_id VARCHAR,
    context_sentence_ids VARCHAR[],  -- Array of sentences that provided context
    signal_type VARCHAR,
    signal_value DOUBLE,
    context_reasoning TEXT
);
```

## Key Insight: Window Patterns to Prioritize

```python
HIGH_VALUE_PATTERNS = [
    {
        'name': 'buried_comorbidity',
        'pattern': ['statistical_finding', 'not_studied', 'different_focus'],
        'example': "We found X↔Y (OR=2.5). This was not explored. We focused on Z.",
        'discovery_value': 9/10
    },
    {
        'name': 'exclusion_revelation',
        'pattern': ['excluded_patients_with', 'high_prevalence', 'no_justification'],
        'example': "We excluded patients with depression (34%). [No explanation why]",
        'discovery_value': 8/10
    },
    {
        'name': 'baseline_surprise',
        'pattern': ['baseline_table', 'unexpected_association', 'no_followup'],
        'example': "Table 1: Diabetes prevalence 45% in arthritis group. [Never mentioned again]",
        'discovery_value': 7/10
    }
]
```

## Summary: The Hybrid Approach is Essential

1. **Single sentences** → Get basic entities, stats, and initial flags
2. **3-5 sentence windows** → Detect mentioned-not-studied, hidden comorbidities
3. **7-sentence windows** → Understand research gaps, causal chains
4. **Paragraph level** → Catch narrative flow, research pivots
5. **Document level** → Verify if finding appears elsewhere

**Critical: Your most valuable discoveries (hidden comorbidities that aren't studied) REQUIRE context windows of 3-5 sentences minimum.**
```

