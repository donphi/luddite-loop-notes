# ES Structure


## Content




~~~{=html}
<pre class="notion-ascii-diagram"><code>╔════════════════════════════════════════════════════════════════════════════════════════╗
║                  <strong> UK BIOBANK FEATURE EXTRACTION PIPELINE: PIPELINE 4                   ║
║                               (Excluding Final Scoring)          </strong>                      ║
╚════════════════════════════════════════════════════════════════════════════════════════╝


 ┌──────────────────────────────────────────────────────────────────────────────────────┐
 │                              <strong>      DATA SOURCES    </strong>                                  │
 ├──────────────────────────────────────────────────────────────────────────────────────┤
 │                                                                                      │
 │  ┌──────────────────────────────────┐     ┌───────────────────────────────────────┐  │
 │  │     <strong> paper.json (per paper)      │     │          ukb_showcase.duckdb     </strong>     │  │ 
 │  │    (~6,600 papers in corpus)     │     │         (UK Biobank Metadata)         │  │
 │  ├──────────────────────────────────┤     ├───────────────────────────────────────┤  │
 │  │  <strong>lines[]:  </strong>                      │     │ <strong> ukb_fields table:   </strong>                 │  │
 │  │    • text                        │     │    • field_id: &quot;21001&quot;                │  │
 │  │    • page_num                    │     │    • title: &quot;Body mass index (BMI)&quot;   │  │
 │  │    • line_token_id: &quot;L123&quot;       │     │    • units: &quot;kg/m2&quot;                   │  │
 │  │    • bbox: [x0,y0,x1,y1]         │     │    • acr_abb_1..15: curated acronyms  │  │
 │  │    • tags[]: [{type:&quot;body&quot;}]     │     │    • category_title, notes, etc.      │  │
 │  │    • words[]:                    │     │                                       │  │
 │  │        token_id: &quot;W456&quot;          │     │  <strong>~10,000 features total   </strong>            │  │
 │  │        text: &quot;BMI&quot;               │     └───────────────────────────────────────┘  │
 │  │        bbox: [x0,y0,x1,y1]       │                                                │
 │  │        char_indices: [0,1,2]     │                                                │
 │  │                                  │                                                │
 │  │ <strong> tables[]: </strong>                      │                                                │
 │  │   <strong> cells[]: </strong>                     │                                                │
 │  │      • text, is_header           │                                                │
 │  │      • is_row_header             │                                                │
 │  │      • row_idx, col_idx          │                                                │
 │  │      • line_token_ids: [&quot;L789&quot;]  │                                                │
 │  └──────────────────────────────────┘                                                │
 │                                                                                      │
 └──────────────────────────────────────────────────────────────────────────────────────┘
                                            │                                          
                                            ▼
╔════════════════════════════════════════════════════════════════════════════════════════╗
║                                <strong> STAGE 0: CORPUS INDEXING  </strong>                             ║
║                                   <strong>  Elasticsearch  </strong>                                    ║
╠════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                        ║
║  <strong>FOR EACH paper.json: </strong>                                                                 ║
║   ├─ <strong>Extract LINES by source_type (priority-based single-indexing):   </strong>                 ║
║   │    <strong>Priority:</strong> title &gt; section_header &gt; caption &gt; abstract &gt; body                    ║
║   │                                                                                    ║
║   │    <strong>Zone configs from resources.yaml:</strong>                                               ║
║   │    ┌─────────────────────────────────────────────────────────────────────────┐     ║
║   │    │  <strong>body:</strong>           tags_include=[&quot;body&quot;,&quot;list_item&quot;]                      │     ║
║   │    │                  tags_exclude=[&quot;reference&quot;,&quot;citation&quot;,&quot;footnote&quot;]       │     ║
║   │    │  <strong>abstract:</strong>       tags_include=[&quot;abstract&quot;]                              │     ║
║   │    │  <strong>title:</strong>          tags_include=[&quot;title&quot;]                                 │     ║
║   │    │  <strong>section_header:</strong> tags_include=[&quot;section_header&quot;]                        │     ║
║   │    │  <strong>caption: </strong>       tags_include=[&quot;figure_caption&quot;,&quot;table_caption&quot;]        │     ║
║   │    └─────────────────────────────────────────────────────────────────────────┘     ║
║   │                                                                                    ║
║   ├─ <strong>Apply MULTI-LINE WINDOWING (for body, abstract zones):  </strong>                          ║
║   │    ┌─────────────────────────────────────────────────────────────────────────┐     ║
║   │    │  <strong>line_windows: </strong>                                                         │     ║
║   │    │    enabled: true                                                        │     ║
║   │    │    window_size_lines: 3                                                 │     ║
║   │    │    step_lines: 1                                                        │     ║
║   │    │    join_with: &quot; &quot;                                                       │     ║
║   │    │    center_line_catching: true                                           │     ║
║   │    │    disallow_cross_page: true                                            │     ║
║   │    │    windowed_zones: [&quot;body&quot;, &quot;abstract&quot;]                                 │     ║
║   │    │                                                                         │     ║
║   │    │  <strong>EDGE-SHIFTED WINDOW STRATEGY: </strong>                                         │     ║
║   │    │  <strong>Every line becomes center exactly once: </strong>                               │     ║
║   │    │    L1-centered: [L1, L2, PAD]  center_idx=0                             │     ║
║   │    │    L2-centered: [L1, L2, L3]   center_idx=1  (standard)                 │     ║
║   │    │    Ln-centered: [PAD, Ln-1, Ln] center_idx=2                            │     ║
║   │    └─────────────────────────────────────────────────────────────────────────┘     ║
║   │                                                                                    ║
║   ├─ <strong>Extract TABLE CELLS (no windowing):</strong>                                               ║
║   │    • table_header:     cell.is_header == true                                      ║
║   │    • table_row_header: cell.is_row_header == true                                  ║
║   │    • table_data_cell:  neither (when enabled)                                      ║
║   │                                                                                    ║
║   └─ <strong>INDEX each document to Elasticsearch: </strong>                                            ║
║                                                                                        ║
║        ┌───────────────────────────────────────────────────────────────────────┐       ║
║        │  <strong>ES Document (ukb_paper_corpus index)    </strong>                             │       ║
║        ├───────────────────────────────────────────────────────────────────────┤       ║
║        │  doc_id:          &quot;2021_Smith_10.123&quot;                                 │       ║
║        │  sentence_id:     &quot;2021_Smith_10.123_body_L456&quot;                       │       ║
║        │  text:            &quot;The mean BMI was 25.3 kg/m2&quot;                       │       ║
║        │  text_lower:      &quot;the mean bmi was 25.3 kg/m2&quot;                       │       ║
║        │  source_type:     &quot;body&quot;|&quot;abstract&quot;|&quot;title&quot;|&quot;table_header&quot;|...        │       ║
║        │                                                                       │       ║
║        │  <strong>── CENTER-LINE CATCHING (windowed docs only) ──────────────────────</strong>  │       ║
║        │  line_texts:      [&quot;Line1 text&quot;, &quot;Line2 text&quot;, &quot;Line3 text&quot;]          │       ║
║        │  center_line_index: 1  (0-indexed position)                           │       ║
║        │  center_line_token_id: &quot;L456&quot;                                         │       ║
║        │  words_per_line:  [8, 12, 6]                                          │       ║
║        │                                                                       │       ║
║        │  <strong>── BBOX PROVENANCE (NON-NEGOTIABLE) ───────────────────────────────</strong>  │       ║
║        │  source_id:        &quot;L456&quot; (line) or &quot;T1_R2C0&quot; (cell)                  │       ║
║        │  page_num:         3                                                  │       ║
║        │  line_token_ids:   [&quot;L454&quot;,&quot;L455&quot;,&quot;L456&quot;]  (all lines in window)      │       ║
║        │  word_token_ids:   [&quot;W100&quot;,&quot;W101&quot;,&quot;W102&quot;,...]                         │       ║
║        │  word_texts:       [&quot;The&quot;,&quot;mean&quot;,&quot;BMI&quot;,...]  (1:1 with token_ids)     │       ║
║        │  word_char_starts: [0, 4, 9, ...]                                     │       ║
║        │  word_char_ends:   [3, 8, 12, ...]                                    │       ║
║        │  word_bboxes:      [x0,y0,x1,y1, x0,y0,x1,y1, ...]  (flattened)       │       ║
║        │  word_bboxes_json: [[x0,y0,x1,y1],[x0,y0,x1,y1],...]                  │       ║
║        │                                                                       │       ║
║        │  paper_title:     &quot;Obesity and mortality...&quot;                          │       ║
║        │  indexed_at:      &quot;2026-01-06T12:00:00Z&quot;                              │       ║
║        └───────────────────────────────────────────────────────────────────────┘       ║
║                                                                                        ║
║  <strong>CONFIG (resources.yaml):  </strong>                                                            ║
║    elasticsearch.index: &quot;ukb_paper_corpus&quot;                                             ║
║    elasticsearch.number_of_shards: 1                                                   ║
║    indexing.bulk_size: 500                                                             ║
║    indexing.max_workers: 16                                                            ║
║    exclusions.min_text_length: 2                                                       ║
║    exclusions.max_text_length: 10000                                                   ║
║                                                                                        ║
║  <strong>OUTPUT:</strong> Elasticsearch index &quot;ukb_paper_corpus&quot; (~6.5 millions of documents)           ║
║                                                                                        ║
╚════════════════════════════════════════════════════════════════════════════════════════╝
                                            │
                                            ▼
╔════════════════════════════════════════════════════════════════════════════════════════╗
║                           <strong>   STAGE 1: ALIAS DISCOVERY    </strong>                              ║
║                    <strong>field_id aliases (potensial pattern mappings)     </strong>                  ║
╠════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                        ║
║  <strong>FOR EACH feature from ukb_fields (DuckDB): </strong>                                           ║
║                                                                                        ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │  <strong>STEP 1: Generate Base Aliases    </strong>                                               │  ║
║  │  ─────────────────────────────────────────────────────────────────────────────   │  ║
║  │  <strong>Input:</strong> field_id=&quot;21001&quot;, title=&quot;Body mass index (BMI)&quot;, acr_abb_1=&quot;BMI&quot;         │  ║
║  │                                                                                  │  ║
║  │  <strong>Field ID patterns (generate_field_id_patterns): </strong>                                │  ║
║  │  ┌────────────────────────────────────────────────────────────────────────────┐  │  ║
║  │  │  <strong>SAFE templates (always applied): </strong>                                         │  │  ║
║  │  │    &quot;field {id}&quot;, &quot;feature {id}&quot;, &quot;ukb:{id}&quot;, &quot;ukb-{id}&quot;, &quot;ukb_{id}&quot;        │  │  ║
║  │  │    &quot;code {id}&quot;, &quot;variable {id}&quot;, &quot;phenotype {id}&quot;, &quot;biomarker {id}&quot;        │  │  ║
║  │  │    ...+ lowercase variants                                                 │  │  ║
║  │  │                                                                            │  │  ║
║  │  │  <strong>RISKY templates (only if len(field_id) &gt;= 5): </strong>                            │  │  ║
║  │  │    &quot;({id})&quot;, &quot;[{id}]&quot;, &quot;#{id}&quot;, &quot;f{id}&quot;, &quot;F{id}&quot;                           │  │  ║
║  │  │    (Excluded for short IDs like &quot;115&quot; to avoid citation markers)           │  │  ║
║  │  └────────────────────────────────────────────────────────────────────────────┘  │  ║
║  │                                                                                  │  ║
║  │  <strong>Title variations:</strong>                                                               │  ║
║  │    • Original: &quot;Body mass index (BMI)&quot;                                           │  ║
║  │    • Lowercase: &quot;body mass index (bmi)&quot;                                          │  ║
║  │    • Lemmatized: &quot;body mass index&quot; (stopwords removed: of, the, and etc.)        │  ║
║  │                                                                                  │  ║
║  │  <strong>Curated acronyms from acr_abb_1..15:</strong> &quot;BMI&quot;, &quot;bmi&quot;                               │  ║
║  │                                                                                  │  ║
║  │  <strong>Output:</strong> [&quot;21001&quot;, &quot;field 21001&quot;, &quot;body mass index&quot;, &quot;BMI&quot;, ...]                 │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                           │                                            ║
║                                           ▼                                            ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │  <strong>STEP 2: Quality Filter (is_clean_alias)      </strong>                                   │  ║
║  │  ──────────────────────────────────────────────────────────────────────────────  │  ║
║  │                                                                                  │  ║
║  │  For each alias ▶ batch ES query for (text_hits, table_hits, doc_count)          │  ║
║  │                                                                                  │  ║
║  │  <strong>GATE 1: Table Artifact Blacklist </strong>                                               │  ║
║  │    Reject: &quot;NaN&quot;, &quot;n/a&quot;, &quot;null&quot;, &quot;---&quot;, &quot;|&quot;, &quot;figure&quot;, &quot;table&quot;, &quot;ci&quot;, &quot;%&quot;        │  ║
║  │                                                                                  │  ║
║  │  <strong>GATE 2: Length Limits </strong>                                                          │  ║
║  │    max_alias_length: 300 chars                                                   │  ║
║  │                                                                                  │  ║
║  │  <strong>GATE 3: Alphanumeric Ratio</strong>                                                      │  ║
║  │    min_alnum_ratio: 0.60  (reject &quot;???&quot;, &quot;---&quot;, etc.)                            │  ║
║  │                                                                                  │  ║
║  │  <strong>GATE 4: Minimum Corpus Hits</strong>                                                     │  ║
║  │    min_alias_hits: 1  (must appear somewhere in corpus)                          │  ║
║  │                                                                                  │  ║
║  │  <strong>GATE 5: Stopword Filter</strong>                                                         │  ║
║  │    max_doc_freq_fraction: 0.70  (&gt;70% of docs = stopword)                        │  ║
║  │    Rejects: &quot;patient&quot;, &quot;study&quot;, &quot;data&quot;, &quot;analysis&quot;, etc.                         │  ║
║  │                                                                                  │  ║
║  │  <strong>GATE 6: Table Dominance </strong>                                                        │  ║
║  │    max_table_dominance: 0.85  (&gt;85% in tables = artifact)                        │  ║
║  │                                                                                  │  ║
║  │  <strong>Output:</strong> clean_aliases = [&quot;BMI&quot;, &quot;body mass index&quot;, &quot;field 21001&quot;, ...]          │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                          │                                             ║
║                                          ▼                                             ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │ <strong> STEP 3: Collocate Expansion  </strong>                                                   │  ║
║  │  ──────────────────────────────────────────────────────────────────────────────  │  ║
║  │                                                                                  │  ║
║  │  Gather contexts from ES where clean_aliases appear                              │  ║
║  │  Find co-occurring words with high <strong>&quot;lift&quot;</strong> score                                  │  ║
║  │                                                                                  │  ║
║  │  <strong>Parameters (feature_extraction.yaml):  </strong>                                         │  ║
║  │    collocation.window_size: 5 words left/right                                   │  ║
║  │    collocation.min_count: 25 occurrences                                         │  ║
║  │    collocation.top_collocates_to_check: 30                                       │  ║
║  │    collocation.max_contexts_for_collocates: 500                                  │  ║
║  │    collocation.max_aliases_for_context: 10                                       │  ║
║  │                                                                                  │  ║
║  │  For &quot;BMI&quot; find collocates: &quot;mean&quot;, &quot;baseline&quot;, &quot;calculated&quot;, &quot;measured&quot;         │  ║
║  │                                                                                  │  ║
║  │  <strong>Try expansions:</strong> &quot;mean BMI&quot;, &quot;BMI mean&quot;, &quot;baseline BMI&quot;                          │  ║
║  │    • Must exist in corpus                                                        │  ║
║  │    • Must pass is_clean_alias                                                    │  ║
║  │    • Must pass validate_expanded_alias (embedding similarity to title)           │  ║
║  │                                                                                  │  ║
║  │  <strong>Validation thresholds (embedding_thresholds): </strong>                                  │  ║
║  │    expanded_alias_title_sim: 0.55  (must be similar to title)                    │  ║
║  │    expanded_alias_base_sim: 0.62   (must be similar to base aliases)             │  ║
║  │                                                                                  │  ║
║  │  <strong>Output:</strong> final_aliases (max 50 per feature)                                      │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                                                                        ║
║  <strong>EMBEDDERS USED:  </strong>                                                                     ║
║    <strong>Primary: </strong>MedCPT-Query-Encoder + MedCPT-Article-Encoder (bi-encoder)                 ║
║    <strong>Witness:</strong> BioBERT-mnli-snli-scinli-scitail-mednli-stsb                               ║
║    <strong>Ensemble:</strong> weighted_mean (primary=0.70, biobert=0.30)                                ║
║                                                                                        ║
║  <strong>OUTPUT:</strong> feature_alias_map.json                                                        ║
║    {                                                                                   ║
║      <strong>&quot;21001&quot;:</strong> [&quot;BMI&quot;, &quot;body mass index&quot;, &quot;mean BMI&quot;, &quot;field 21001&quot;, ...],              ║
║      <strong>&quot;21002&quot;:</strong> [&quot;Body fat percentage&quot;, &quot;body fat %&quot;, &quot;BF%&quot;, ...],                       ║
║      ...                                                                               ║
║    }                                                                                   ║
║                                                                                        ║
╚════════════════════════════════════════════════════════════════════════════════════════╝
                                           │
                                           ▼
╔════════════════════════════════════════════════════════════════════════════════════════╗
║                   <strong>        STAGE 2: MERGE STAGE 0 &amp; STAGE 1        </strong>                     ║
║                     <strong>   capture field_id aliases from corpus text    </strong>                   ║
╠════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                        ║
║  <strong>INPUTS:</strong>                                                                               ║
║    • Elasticsearch index (from Stage 0)                                                ║
║    • Field ID Aliases: feature_alias_map.json (from Stage 1)                           ║
║    • Pre-computed feature embeddings (from ukb_fields titles)                          ║
║                                                                                        ║
║  <strong>FOR EACH feature_id in alias_map:  </strong>                                                   ║
║                                                                                        ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │ <strong> STEP 1: Search Elasticsearch (Match 1)   </strong>                                       │  ║
║  │  ──────────────────────────────────────────────────────────────────────────────  │  ║
║  │                                                                                  │  ║
║  │  <strong>Query structure:</strong>                                                                │  ║
║  │    {                                                                             │  ║
║  │      &quot;query&quot;: {                                                                  │  ║
║  │        &quot;bool&quot;: {                                                                 │  ║
║  │          &quot;must&quot;: [                                                               │  ║
║  │            {&quot;terms&quot;: {&quot;source_type&quot;: searchable_sections}},                      │  ║
║  │            {&quot;bool&quot;: {                                                            │  ║
║  │              &quot;should&quot;: [                                                         │  ║
║  │                {&quot;match_phrase&quot;: {&quot;text_lower&quot;: &quot;bmi&quot;}},                          │  ║
║  │                {&quot;match_phrase&quot;: {&quot;text_lower&quot;: &quot;body mass index&quot;}},              │  ║
║  │                ...                                                               │  ║
║  │              ], &quot;minimum_should_match&quot;: 1                                        │  ║
║  │            }}                                                                    │  ║
║  │          ]                                                                       │  ║
║  │        }                                                                         │  ║
║  │      },                                                                          │  ║
║  │      &quot;aggs&quot;: {                                                                   │  ║
║  │        &quot;papers&quot;: {                                                               │  ║
║  │          &quot;terms&quot;: {&quot;field&quot;: &quot;doc_id&quot;, &quot;size&quot;: 100000},                           │  ║
║  │          &quot;aggs&quot;: {&quot;sample_contexts&quot;: {&quot;top_hits&quot;: {&quot;size&quot;: 100}}}                │  ║
║  │        }                                                                         │  ║
║  │      }                                                                           │  ║
║  │    }                                                                             │  ║
║  │                                                                                  │  ║
║  │  <strong>Returns:</strong> Grouped by paper_id, with contexts + FULL BBOX provenance              │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                        │                                               ║
║                                        ▼                                               ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │  <strong>STEP 2: Deterministic Alias Matching (Match 2) </strong>                                 │  ║
║  │  ──────────────────────────────────────────────────────────────────────────────  │  ║
║  │                                                                                  │  ║
║  │  <strong>TWO-PASS MATCHING (for bbox derivation): </strong>                                       │  ║
║  │                                                                                  │  ║
║  │  <strong>PASS 1: Word-Sequence Match (exact bbox mapping)</strong>                                │  ║
║  │    • Normalize: &quot;BMI&quot; ▶ &quot;bmi&quot;, strip punctuation                                 │  ║
║  │    • Find alias token sequence in word_texts array                               │  ║
║  │    • Map to word_token_ids + word_bboxes (1:1 alignment)                         │  ║
║  │    • bbox_confidence: &quot;exact&quot;                                                    │  ║
║  │                                                                                  │  ║
║  │  <strong>PASS 2: Char-Offset Fallback (approximate bbox) </strong>                                │  ║
║  │    • For OCR/punctuation recovery (e.g., &quot;year-age&quot; matches &quot;year/age&quot;)          │  ║
║  │    • Uses word_char_starts/word_char_ends for span mapping                       │  ║
║  │    • char_offset_safety (min_alias_len_for_char_offset: 5)                       │  ║
║  │    • bbox_confidence: &quot;approximate&quot;                                              │  ║
║  │                                                                                  │  ║
║  │  <strong>CENTER-LINE CATCHING (for windowed docs): </strong>                                      │  ║
║  │    • Only accept matches overlapping center_line_index                           │  ║
║  │    • Side-line matches filtered out (prevents duplicates)                        │  ║
║  │                                                                                  │  ║
║  │  <strong>OVERLAP RESOLUTION: </strong>                                                            │  ║
║  │    • Longer alias wins ▶ earlier position ▶ lexicographic                        │  ║
║  │    • Non-overlapping matches selected                                            │  ║
║  │                                                                                  │  ║
║  │  <strong>Output per match:</strong>                                                               │  ║
║  │    matched_alias, matched_alias_word_token_ids, matched_alias_word_bboxes        │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                        │                                               ║
║                                        ▼                                               ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │  <strong>STEP 3: Score Context with Dynamic Thresholds (Match 3: HARD) </strong>                  │  ║
║  │  ──────────────────────────────────────────────────────────────────────────────  │  ║
║  │                                                                                  │  ║
║  │  <strong>BUILD CONTEXT SNIPPET (±N words around alias):</strong>                                  │  ║
║  │    context_window.single_word_alias: 3                                           │  ║
║  │    context_window.multi_word_alias: 3                                            │  ║
║  │   &quot;The mean BMI was 25.3&quot; ▶ snippet: &quot;mean BMI was 25.3&quot;                         │  ║
║  │                                                                                  │  ║
║  │  <strong>GET DYNAMIC THRESHOLD (get_threshold_for_alias): </strong>                               │  ║
║  │  ┌────────────────────────────────────────────────────────────────────────────┐  │  ║
║  │  │  <strong>ALIAS TYPE                     │ THRESHOLD │ REASON     </strong>                  │  │  ║
║  │  │  ───────────────────────────────────────────────────────────────────────── │  │  ║
║  │  │  Field ID pattern               │   0.40   │  Highly trusted (explicit)    │  │  ║
║  │  │  e.g., &quot;field 21001&quot;, &quot;ukb:401&quot; │          │                               │  │  ║
║  │  │                                 │          │                               │  │  ║
║  │  │  1-2 char acronym               │   0.82   │  Very strict (&quot;P&quot;, &quot;BP&quot;)      │  │  ║
║  │  │                                 │          │                               │  │  ║
║  │  │  3 char acronym                 │   0.68   │  Moderately strict (&quot;BMI&quot;)    │  │  ║
║  │  │                                 │          │                               │  │  ║
║  │  │  4+ char acronym                │   0.62   │  Normal (&quot;COPD&quot;, &quot;ADHD&quot;)      │  │  ║
║  │  │                                 │          │                               │  │  ║
║  │  │  Regular alias                  │   0.62   │  Base threshold               │  │  ║
║  │  │  e.g., &quot;body mass index&quot;        │          │                               │  │  ║
║  │  └────────────────────────────────────────────────────────────────────────────┘  │  ║
║  │                                                                                  │  ║
║  │ <strong> COMPUTE EMBEDDING SIMILARITY:  </strong>                                                 │  ║
║  │    feature_embedding = MedCPT-Query-Encoder(&quot;Body mass index (BMI)&quot;)             │  ║
║  │    context_embedding = MedCPT-Article-Encoder(&quot;mean BMI was 25.3&quot;)               │  ║
║  │    score = dot_product(feature_embedding, context_embedding)                     │  ║
║  │                                                                                  │  ║
║  │  <strong>WITNESS ENSEMBLE SCORING: </strong>                                                      │  ║
║  │    primary (MedCPT): 0.82, biobert_stsb: 0.79                                    │  ║
║  │    combined = 0.70 * 0.82 + 0.30 * 0.79 = 0.811                                  │  ║
║  │    quorum: k_of_n=1 must clear low_threshold (0.40)                              │  ║
║  │                                                                                  │  ║
║  │  <strong>APPLY THRESHOLD:   </strong>                                                             │  ║
║  │    if combined &gt;= alias_threshold: keep                                          │  ║
║  │    else if max(model_scores) &gt;= low_threshold: keep (fallback strategy: &quot;max&quot;)   │  ║
║  │    else: reject (score = 0.0)                                                    │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                        │                                               ║
║                                        ▼                                               ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │  <strong>STEP 4: Dual-Anchor Validation (Match 4: long aliases BM25 Score)     </strong>          │  ║
║  │  ─────────────────────────────────────────────────────────────────────────────   │  ║
║  │                                                                                  │  ║
║  │  dual_anchor.enabled: true                                                       │  ║
║  │  dual_anchor.min_alias_length_for_dual_anchor: 6                                 │  ║
║  │  dual_anchor.bm25_threshold: 0.30                                                │  ║
║  │  dual_anchor.combine_strategy: &quot;require_both&quot;                                    │  ║
║  │                                                                                  │  ║
║  │  <strong>For aliases &gt;= 6 chars, require BOTH:</strong>                                           │  ║
║  │    Anchor 1: BM25 normalized &gt;= 0.30                                             │  ║
║  │    Anchor 2: Embedding score &gt;= threshold                                        │  ║
║  │                                                                                  │  ║
║  │  <strong>bm25_normalized</strong> = log(1 + bm25) / log(1 + max_bm25_in_paper)                    │  ║
║  │                                                                                  │  ║
║  │  <strong>If EITHER fails:</strong> bm25_rejected=True, score=0.0 (but kept for debug)             │  ║
║  │                                                                                  │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                        │                                               ║
║                                        ▼                                               ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │  <strong>STEP 5: Window Propagation ( Match 5: short field IDs)    </strong>                      │  ║
║  │  ─────────────────────────────────────────────────────────────────────────────   │  ║
║  │                                                                                  │  ║
║  │  <strong>When trusted match (is_hard_match=True) found: </strong>                                 │  ║
║  │    1. Find anchor at line L258 (e.g., &quot;field 95&quot;)                                │  ║
║  │    2. Query ES for lines [L256, L257, L258, L259, L260]                          │  ║
║  │    3. Search for risky patterns: &quot;(95)&quot;, &quot;[95]&quot;, &quot;#{95}&quot;                         │  ║
║  │    4. If found at L260 → expand frontier and repeat                              │  ║
║  │    5. Score propagated matches against feature embedding                         │  ║
║  │                                                                                  │  ║
║  │  <strong>window_propagation.window_radius:</strong> 2                                             │  ║
║  │  <strong>window_propagation.max_iterations:</strong> 3                                            │  ║
║  │  <strong>window_propagation.min_embedding_score:</strong> 0.70                                    │  ║
║  │                                                                                  │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                        │                                               ║
║                                        ▼                                               ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │ <strong> STEP 6: Classify &amp; Build Feature Card (Match Final Rank &amp; Build)     </strong>           │  ║
║  │  ──────────────────────────────────────────────────────────────────────────────  │  ║
║  │                                                                                  │  ║
║  │  <strong>CONFIDENCE TIERS (classify_confidence):  </strong>                                       │  ║
║  │    sampling.high_threshold: <strong>SCORE 0.80    ▶   HIGH   </strong>                            │  ║
║  │    sampling.mid_threshold: <strong> SCORE 0.60    ▶   MEDIUM </strong>                            │  ║
║  │    sampling.low_threshold: <strong> SCORE 0.40    ▶   LOW </strong>                               │  ║
║  │                            <strong> SCORE &lt; 0.40  ▶   REJECTED </strong>(not in output)           │  ║
║  │                                                                                  │  ║
║  │  <strong>Final Feature Card contains: </strong>                                                   │  ║
║  │    {                                                                             │  ║
║  │      &quot;field_id&quot;: &quot;21001&quot;,                                                        │  ║
║  │      &quot;title&quot;: &quot;Body mass index (BMI)&quot;,                                           │  ║
║  │      &quot;contexts&quot;: {                                                               │  ║
║  │        &quot;high&quot;: [                                                                 │  ║
║  │          {                                                                       │  ║
║  │            &quot;paper_id&quot;: &quot;2021_Smith_10.123&quot;,                                      │  ║
║  │            &quot;text&quot;: &quot;The mean BMI was 25.3 kg/m2&quot;,                                │  ║
║  │            &quot;context_snippet&quot;: &quot;mean BMI was 25.3&quot;,  ← ACTUAL model input         │  ║
║  │            &quot;score&quot;: 0.82,                                                        │  ║
║  │            &quot;matched_alias&quot;: &quot;mean bmi&quot;,                                          │  ║
║  │            &quot;match_method&quot;: &quot;word_sequence&quot;,                                      │  ║
║  │            &quot;bbox_confidence&quot;: &quot;exact&quot;,                                           │  ║
║  │            &quot;scores_by_model&quot;: {&quot;primary&quot;:0.82, &quot;biobert_stsb&quot;:0.79},             │  ║
║  │            &quot;is_hard_match&quot;: false,                                               │  ║
║  │            &quot;bm25_score&quot;: 12.5,                                                   │  ║
║  │            &quot;bm25_normalized&quot;: 0.65,                                              │  ║
║  │                                                                                  │  ║
║  │           <strong> ── BBOX PROVENANCE ──  </strong>                                               │  ║
║  │            &quot;doc_id&quot;: &quot;2021_Smith_10.123&quot;,                                        │  ║
║  │            &quot;page_num&quot;: 3,                                                        │  ║
║  │            &quot;source_id&quot;: &quot;L456&quot;,                                                  │  ║
║  │            &quot;matched_alias_word_token_ids&quot;: [&quot;W101&quot;, &quot;W102&quot;],                     │  ║ 
║  │            &quot;matched_alias_word_bboxes&quot;: [[160,200,200,220],[210,200,250,220]]    │  ║
║  │          }, ...                                                                  │  ║
║  │        ],                                                                        │  ║
║  │        &quot;medium&quot;: [...],                                                          │  ║
║  │        &quot;low&quot;: [...]                                                              │  ║
║  │      }                                                                           │  ║
║  │    }                                                                             │  ║
║  │                                                                                  │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                                                                        ║
║  <strong>RERANKING APPLIED: MedCPT Cross-Encoder Reranking </strong>                                    ║
║    reranker.enabled: true                                                              ║
║    reranker.apply.top_k_per_paper: 50                                                  ║
║    reranker.apply.min_score_to_rerank: 0.40                                            ║
║    Uses (title, context_snippet) pairs for cross-attention scoring                     ║
║                                                                                        ║
║  <strong>OUTPUT: </strong>                                                                              ║
║    • feature_cards.jsonl (one line per feature)                                        ║
║    • feature_to_papers.json (inverted index: {paper_id: {field_id: match_data}})       ║
║                                                                                        ║
╚════════════════════════════════════════════════════════════════════════════════════════╝

╔════════════════════════════════════════════════════════════════════════════════════════╗
║                            <strong>  BBOX PROVENANCE FLOW  </strong>                                    ║
║               <strong>(How we draw rectangles on original PDF page images)  </strong>                   ║
╠════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                        ║
║    <strong>1.paper.json        2.Stage 0 (ES)      3.Stage 2 (Scoring)      4.HIL Rendering</strong>    ║
║    ────────────        ──────────────      ───────────────────      ───────────────    ║
║                    │                    │                       │                      ║
║ <strong>lines[0]: </strong>         │ <strong>doc =</strong> {            │ <strong>context =</strong> {           │   <strong>Load page PNG: </strong>    ║
║  text: &quot;Mean BMI&quot;  │   text: &quot;Mean BMI&quot; │   text: &quot;Mean BMI&quot;    │     page_3.png       ║
║  page_num: 3       │   page_num: 3      │   page_num: 3         │                      ║
║  words: [          │   word_token_ids:  │   matched_alias:      │   Parse bboxes:      ║
║   {                │     [&quot;W1&quot;,&quot;W2&quot;]    │     &quot;bmi&quot;             │     [[160,200,       ║
║    token_id: &quot;W1&quot;  │   word_texts:      │   matched_alias_word_ │       200,220]]      ║
║    text: &quot;Mean&quot;    │     [&quot;Mean&quot;,&quot;BMI&quot;] │     token_ids:        │                      ║
║    bbox: [100,     │   word_char_starts:│      [&quot;W2&quot;]           │   Find word &quot;W2&quot;:    ║
║          200,      │     [0, 5]         │   matched_alias_word_ │     [160,200,        ║
║          150,      │   word_char_ends:  │     bboxes:           │      200,220]        ║
║          220]      │     [4, 8]         │      [[160,200,       │                      ║
║   },               │   word_bboxes_json:│        200,220]]      │   <strong>Draw rectangle:</strong>    ║
║   {                │    &quot;[[100,200,     │                       │  ┌──────────────┐    ║
║    token_id: &quot;W2&quot;  │       150,220],    │                       │  │   ┌─────┐    │    ║
║    text: &quot;BMI&quot;     │      [160,200,     │                       │  │   │ <strong>BMI</strong> │    │    ║
║    bbox: [160,     │       200,220]]&quot;   │                       │  │   └─────┘    │    ║
║          200,      │      ...           │                       │  │    <strong>Page 3 </strong>   │    ║
║          200,      │  }                 │                       │  └──────────────┘    ║
║          220]      │                    │                       │                      ║
║   }                │                    │                       │                      ║
║ ]                  │                    │                       │                      ║
║                    │                    │                       │                      ║
╚════════════════════════════════════════════════════════════════════════════════════════╝


╔════════════════════════════════════════════════════════════════════════════════════════╗
║                          <strong>  KEY CONFIGURATION SUMMARY  </strong>                                 ║
╠════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                        ║
║  <strong>resources.yaml (Stage 0)</strong>         │  <strong>feature_extraction.yaml (Stages 1-2) </strong>             ║
║  ─────────────────────────────────┼──────────────────────────────────────────────────  ║
║  <strong>elasticsearch: </strong>                  │  <strong>quality:  </strong>                                        ║
║    index: ukb_paper_corpus        │    min_alias_hits: 1                               ║
║    number_of_shards: 1            │    min_alias_length: 2                             ║
║    bulk_size: 500                 │    max_alias_length: 300                           ║
║                                   │    min_alnum_ratio: 0.60                           ║
║  <strong>line_windows:  </strong>                  │    max_doc_freq_fraction: 0.70                     ║
║    window_size_lines: 3           │    max_table_dominance: 0.85                       ║
║    step_lines: 1                  │                                                    ║
║    center_line_catching: true     │  <strong>embedding_thresholds:</strong>                             ║
║    windowed_zones:                │    base_threshold: 0.62                            ║
║      - body                       │    acronym_1_2_char: 0.82                          ║
║      - abstract                   │    acronym_3_char: 0.68                            ║
║                                   │    acronym_4plus_char: 0.62                        ║
║  <strong>extraction_zones:  </strong>              │    field_id_pattern: 0.40                          ║
║    body: tags_include=[body,      │    expanded_alias_title_sim: 0.55                  ║
║           list_item]              │    expanded_alias_base_sim: 0.62                   ║
║    abstract: tags_include=        │                                                    ║
║           [abstract]              │  <strong>collocation: </strong>                                     ║
║    table_header: is_header=true   │    window_size: 5                                  ║
║                                   │    min_count: 25                                   ║
║  <strong>exclusions: </strong>                     │    top_collocates_to_check: 30                     ║
║    excluded_tags:                 │                                                    ║
║      - reference                  │  <strong>sampling (confidence tiers):</strong>                      ║
║      - citation                   │    high_threshold: 0.80                            ║
║      - footnote                   │    mid_threshold: 0.60                             ║
║    min_text_length: 2             │    low_threshold: 0.40                             ║
║    max_text_length: 10000         │                                                    ║
║                                   │  <strong>dual_anchor: </strong>                                     ║
║                                   │    min_alias_length_for_dual_anchor: 6             ║
║                                   │    bm25_threshold: 0.30                            ║
║                                   │    combine_strategy: require_both                  ║
║                                   │                                                    ║
║                                   │  <strong>witness_scoring: </strong>                                 ║
║                                   │    strategy: weighted_mean                         ║
║                                   │    weights: primary=0.70, biobert=0.30             ║
║                                   │    quorum: k_of_n=1                                ║
║                                   │                                                    ║
║                                   │  <strong>embedder:</strong> MedCPT-Query/Article-Encoder            ║
║                                   │  <strong>witness:</strong> BioBERT-mnli-snli-stsb                   ║
║                                   │  <strong>reranker:</strong> MedCPT-Cross-Encoder                    ║
║                                   │                                                    ║
╚════════════════════════════════════════════════════════════════════════════════════════╝</code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
╔════════════════════════════════════════════════════════════════════════════════════════╗
║                  \textbf{ UK BIOBANK FEATURE EXTRACTION PIPELINE: PIPELINE 4                   ║
║                               (Excluding Final Scoring)          }                      ║
╚════════════════════════════════════════════════════════════════════════════════════════╝


 ┌──────────────────────────────────────────────────────────────────────────────────────┐
 │                              \textbf{      DATA SOURCES    }                                  │
 ├──────────────────────────────────────────────────────────────────────────────────────┤
 │                                                                                      │
 │  ┌──────────────────────────────────┐     ┌───────────────────────────────────────┐  │
 │  │     \textbf{ paper.json (per paper)      │     │          ukb_showcase.duckdb     }     │  │ 
 │  │    (~6,600 papers in corpus)     │     │         (UK Biobank Metadata)         │  │
 │  ├──────────────────────────────────┤     ├───────────────────────────────────────┤  │
 │  │  \textbf{lines[]:  }                      │     │ \textbf{ ukb_fields table:   }                 │  │
 │  │    • text                        │     │    • field_id: "21001"                │  │
 │  │    • page_num                    │     │    • title: "Body mass index (BMI)"   │  │
 │  │    • line_token_id: "L123"       │     │    • units: "kg/m2"                   │  │
 │  │    • bbox: [x0,y0,x1,y1]         │     │    • acr_abb_1..15: curated acronyms  │  │
 │  │    • tags[]: [\textbraceleft{\textbraceright{}type:"body"\textbraceright{}]     │     │    • category_title, notes, etc.      │  │
 │  │    • words[]:                    │     │                                       │  │
 │  │        token_id: "W456"          │     │  \textbf{~10,000 features total   }            │  │
 │  │        text: "BMI"               │     └───────────────────────────────────────┘  │
 │  │        bbox: [x0,y0,x1,y1]       │                                                │
 │  │        char_indices: [0,1,2]     │                                                │
 │  │                                  │                                                │
 │  │ \textbf{ tables[]: }                      │                                                │
 │  │   \textbf{ cells[]: }                     │                                                │
 │  │      • text, is_header           │                                                │
 │  │      • is_row_header             │                                                │
 │  │      • row_idx, col_idx          │                                                │
 │  │      • line_token_ids: ["L789"]  │                                                │
 │  └──────────────────────────────────┘                                                │
 │                                                                                      │
 └──────────────────────────────────────────────────────────────────────────────────────┘
                                            │                                          
                                            ▼
╔════════════════════════════════════════════════════════════════════════════════════════╗
║                                \textbf{ STAGE 0: CORPUS INDEXING  }                             ║
║                                   \textbf{  Elasticsearch  }                                    ║
╠════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                        ║
║  \textbf{FOR EACH paper.json: }                                                                 ║
║   ├─ \textbf{Extract LINES by source_type (priority-based single-indexing):   }                 ║
║   │    \textbf{Priority:} title > section_header > caption > abstract > body                    ║
║   │                                                                                    ║
║   │    \textbf{Zone configs from resources.yaml:}                                               ║
║   │    ┌─────────────────────────────────────────────────────────────────────────┐     ║
║   │    │  \textbf{body:}           tags_include=["body","list_item"]                      │     ║
║   │    │                  tags_exclude=["reference","citation","footnote"]       │     ║
║   │    │  \textbf{abstract:}       tags_include=["abstract"]                              │     ║
║   │    │  \textbf{title:}          tags_include=["title"]                                 │     ║
║   │    │  \textbf{section_header:} tags_include=["section_header"]                        │     ║
║   │    │  \textbf{caption: }       tags_include=["figure_caption","table_caption"]        │     ║
║   │    └─────────────────────────────────────────────────────────────────────────┘     ║
║   │                                                                                    ║
║   ├─ \textbf{Apply MULTI-LINE WINDOWING (for body, abstract zones):  }                          ║
║   │    ┌─────────────────────────────────────────────────────────────────────────┐     ║
║   │    │  \textbf{line_windows: }                                                         │     ║
║   │    │    enabled: true                                                        │     ║
║   │    │    window_size_lines: 3                                                 │     ║
║   │    │    step_lines: 1                                                        │     ║
║   │    │    join_with: " "                                                       │     ║
║   │    │    center_line_catching: true                                           │     ║
║   │    │    disallow_cross_page: true                                            │     ║
║   │    │    windowed_zones: ["body", "abstract"]                                 │     ║
║   │    │                                                                         │     ║
║   │    │  \textbf{EDGE-SHIFTED WINDOW STRATEGY: }                                         │     ║
║   │    │  \textbf{Every line becomes center exactly once: }                               │     ║
║   │    │    L1-centered: [L1, L2, PAD]  center_idx=0                             │     ║
║   │    │    L2-centered: [L1, L2, L3]   center_idx=1  (standard)                 │     ║
║   │    │    Ln-centered: [PAD, Ln-1, Ln] center_idx=2                            │     ║
║   │    └─────────────────────────────────────────────────────────────────────────┘     ║
║   │                                                                                    ║
║   ├─ \textbf{Extract TABLE CELLS (no windowing):}                                               ║
║   │    • table_header:     cell.is_header == true                                      ║
║   │    • table_row_header: cell.is_row_header == true                                  ║
║   │    • table_data_cell:  neither (when enabled)                                      ║
║   │                                                                                    ║
║   └─ \textbf{INDEX each document to Elasticsearch: }                                            ║
║                                                                                        ║
║        ┌───────────────────────────────────────────────────────────────────────┐       ║
║        │  \textbf{ES Document (ukb_paper_corpus index)    }                             │       ║
║        ├───────────────────────────────────────────────────────────────────────┤       ║
║        │  doc_id:          "2021_Smith_10.123"                                 │       ║
║        │  sentence_id:     "2021_Smith_10.123_body_L456"                       │       ║
║        │  text:            "The mean BMI was 25.3 kg/m2"                       │       ║
║        │  text_lower:      "the mean bmi was 25.3 kg/m2"                       │       ║
║        │  source_type:     "body"|"abstract"|"title"|"table_header"|...        │       ║
║        │                                                                       │       ║
║        │  \textbf{── CENTER-LINE CATCHING (windowed docs only) ──────────────────────}  │       ║
║        │  line_texts:      ["Line1 text", "Line2 text", "Line3 text"]          │       ║
║        │  center_line_index: 1  (0-indexed position)                           │       ║
║        │  center_line_token_id: "L456"                                         │       ║
║        │  words_per_line:  [8, 12, 6]                                          │       ║
║        │                                                                       │       ║
║        │  \textbf{── BBOX PROVENANCE (NON-NEGOTIABLE) ───────────────────────────────}  │       ║
║        │  source_id:        "L456" (line) or "T1_R2C0" (cell)                  │       ║
║        │  page_num:         3                                                  │       ║
║        │  line_token_ids:   ["L454","L455","L456"]  (all lines in window)      │       ║
║        │  word_token_ids:   ["W100","W101","W102",...]                         │       ║
║        │  word_texts:       ["The","mean","BMI",...]  (1:1 with token_ids)     │       ║
║        │  word_char_starts: [0, 4, 9, ...]                                     │       ║
║        │  word_char_ends:   [3, 8, 12, ...]                                    │       ║
║        │  word_bboxes:      [x0,y0,x1,y1, x0,y0,x1,y1, ...]  (flattened)       │       ║
║        │  word_bboxes_json: [[x0,y0,x1,y1],[x0,y0,x1,y1],...]                  │       ║
║        │                                                                       │       ║
║        │  paper_title:     "Obesity and mortality..."                          │       ║
║        │  indexed_at:      "2026-01-06T12:00:00Z"                              │       ║
║        └───────────────────────────────────────────────────────────────────────┘       ║
║                                                                                        ║
║  \textbf{CONFIG (resources.yaml):  }                                                            ║
║    elasticsearch.index: "ukb_paper_corpus"                                             ║
║    elasticsearch.number_of_shards: 1                                                   ║
║    indexing.bulk_size: 500                                                             ║
║    indexing.max_workers: 16                                                            ║
║    exclusions.min_text_length: 2                                                       ║
║    exclusions.max_text_length: 10000                                                   ║
║                                                                                        ║
║  \textbf{OUTPUT:} Elasticsearch index "ukb_paper_corpus" (~6.5 millions of documents)           ║
║                                                                                        ║
╚════════════════════════════════════════════════════════════════════════════════════════╝
                                            │
                                            ▼
╔════════════════════════════════════════════════════════════════════════════════════════╗
║                           \textbf{   STAGE 1: ALIAS DISCOVERY    }                              ║
║                    \textbf{field_id aliases (potensial pattern mappings)     }                  ║
╠════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                        ║
║  \textbf{FOR EACH feature from ukb_fields (DuckDB): }                                           ║
║                                                                                        ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │  \textbf{STEP 1: Generate Base Aliases    }                                               │  ║
║  │  ─────────────────────────────────────────────────────────────────────────────   │  ║
║  │  \textbf{Input:} field_id="21001", title="Body mass index (BMI)", acr_abb_1="BMI"         │  ║
║  │                                                                                  │  ║
║  │  \textbf{Field ID patterns (generate_field_id_patterns): }                                │  ║
║  │  ┌────────────────────────────────────────────────────────────────────────────┐  │  ║
║  │  │  \textbf{SAFE templates (always applied): }                                         │  │  ║
║  │  │    "field \textbraceleft{\textbraceright{}id\textbraceright{}", "feature \textbraceleft{\textbraceright{}id\textbraceright{}", "ukb:\textbraceleft{\textbraceright{}id\textbraceright{}", "ukb-\textbraceleft{\textbraceright{}id\textbraceright{}", "ukb_\textbraceleft{\textbraceright{}id\textbraceright{}"        │  │  ║
║  │  │    "code \textbraceleft{\textbraceright{}id\textbraceright{}", "variable \textbraceleft{\textbraceright{}id\textbraceright{}", "phenotype \textbraceleft{\textbraceright{}id\textbraceright{}", "biomarker \textbraceleft{\textbraceright{}id\textbraceright{}"        │  │  ║
║  │  │    ...+ lowercase variants                                                 │  │  ║
║  │  │                                                                            │  │  ║
║  │  │  \textbf{RISKY templates (only if len(field_id) >= 5): }                            │  │  ║
║  │  │    "(\textbraceleft{\textbraceright{}id\textbraceright{})", "[\textbraceleft{\textbraceright{}id\textbraceright{}]", "#\textbraceleft{\textbraceright{}id\textbraceright{}", "f\textbraceleft{\textbraceright{}id\textbraceright{}", "F\textbraceleft{\textbraceright{}id\textbraceright{}"                           │  │  ║
║  │  │    (Excluded for short IDs like "115" to avoid citation markers)           │  │  ║
║  │  └────────────────────────────────────────────────────────────────────────────┘  │  ║
║  │                                                                                  │  ║
║  │  \textbf{Title variations:}                                                               │  ║
║  │    • Original: "Body mass index (BMI)"                                           │  ║
║  │    • Lowercase: "body mass index (bmi)"                                          │  ║
║  │    • Lemmatized: "body mass index" (stopwords removed: of, the, and etc.)        │  ║
║  │                                                                                  │  ║
║  │  \textbf{Curated acronyms from acr_abb_1..15:} "BMI", "bmi"                               │  ║
║  │                                                                                  │  ║
║  │  \textbf{Output:} ["21001", "field 21001", "body mass index", "BMI", ...]                 │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                           │                                            ║
║                                           ▼                                            ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │  \textbf{STEP 2: Quality Filter (is_clean_alias)      }                                   │  ║
║  │  ──────────────────────────────────────────────────────────────────────────────  │  ║
║  │                                                                                  │  ║
║  │  For each alias ▶ batch ES query for (text_hits, table_hits, doc_count)          │  ║
║  │                                                                                  │  ║
║  │  \textbf{GATE 1: Table Artifact Blacklist }                                               │  ║
║  │    Reject: "NaN", "n/a", "null", "---", "|", "figure", "table", "ci", "%"        │  ║
║  │                                                                                  │  ║
║  │  \textbf{GATE 2: Length Limits }                                                          │  ║
║  │    max_alias_length: 300 chars                                                   │  ║
║  │                                                                                  │  ║
║  │  \textbf{GATE 3: Alphanumeric Ratio}                                                      │  ║
║  │    min_alnum_ratio: 0.60  (reject "???", "---", etc.)                            │  ║
║  │                                                                                  │  ║
║  │  \textbf{GATE 4: Minimum Corpus Hits}                                                     │  ║
║  │    min_alias_hits: 1  (must appear somewhere in corpus)                          │  ║
║  │                                                                                  │  ║
║  │  \textbf{GATE 5: Stopword Filter}                                                         │  ║
║  │    max_doc_freq_fraction: 0.70  (>70% of docs = stopword)                        │  ║
║  │    Rejects: "patient", "study", "data", "analysis", etc.                         │  ║
║  │                                                                                  │  ║
║  │  \textbf{GATE 6: Table Dominance }                                                        │  ║
║  │    max_table_dominance: 0.85  (>85% in tables = artifact)                        │  ║
║  │                                                                                  │  ║
║  │  \textbf{Output:} clean_aliases = ["BMI", "body mass index", "field 21001", ...]          │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                          │                                             ║
║                                          ▼                                             ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │ \textbf{ STEP 3: Collocate Expansion  }                                                   │  ║
║  │  ──────────────────────────────────────────────────────────────────────────────  │  ║
║  │                                                                                  │  ║
║  │  Gather contexts from ES where clean_aliases appear                              │  ║
║  │  Find co-occurring words with high \textbf{"lift"} score                                  │  ║
║  │                                                                                  │  ║
║  │  \textbf{Parameters (feature_extraction.yaml):  }                                         │  ║
║  │    collocation.window_size: 5 words left/right                                   │  ║
║  │    collocation.min_count: 25 occurrences                                         │  ║
║  │    collocation.top_collocates_to_check: 30                                       │  ║
║  │    collocation.max_contexts_for_collocates: 500                                  │  ║
║  │    collocation.max_aliases_for_context: 10                                       │  ║
║  │                                                                                  │  ║
║  │  For "BMI" find collocates: "mean", "baseline", "calculated", "measured"         │  ║
║  │                                                                                  │  ║
║  │  \textbf{Try expansions:} "mean BMI", "BMI mean", "baseline BMI"                          │  ║
║  │    • Must exist in corpus                                                        │  ║
║  │    • Must pass is_clean_alias                                                    │  ║
║  │    • Must pass validate_expanded_alias (embedding similarity to title)           │  ║
║  │                                                                                  │  ║
║  │  \textbf{Validation thresholds (embedding_thresholds): }                                  │  ║
║  │    expanded_alias_title_sim: 0.55  (must be similar to title)                    │  ║
║  │    expanded_alias_base_sim: 0.62   (must be similar to base aliases)             │  ║
║  │                                                                                  │  ║
║  │  \textbf{Output:} final_aliases (max 50 per feature)                                      │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                                                                        ║
║  \textbf{EMBEDDERS USED:  }                                                                     ║
║    \textbf{Primary: }MedCPT-Query-Encoder + MedCPT-Article-Encoder (bi-encoder)                 ║
║    \textbf{Witness:} BioBERT-mnli-snli-scinli-scitail-mednli-stsb                               ║
║    \textbf{Ensemble:} weighted_mean (primary=0.70, biobert=0.30)                                ║
║                                                                                        ║
║  \textbf{OUTPUT:} feature_alias_map.json                                                        ║
║    \textbraceleft{\textbraceright{}                                                                                   ║
║      \textbf{"21001":} ["BMI", "body mass index", "mean BMI", "field 21001", ...],              ║
║      \textbf{"21002":} ["Body fat percentage", "body fat %", "BF%", ...],                       ║
║      ...                                                                               ║
║    \textbraceright{}                                                                                   ║
║                                                                                        ║
╚════════════════════════════════════════════════════════════════════════════════════════╝
                                           │
                                           ▼
╔════════════════════════════════════════════════════════════════════════════════════════╗
║                   \textbf{        STAGE 2: MERGE STAGE 0 & STAGE 1        }                     ║
║                     \textbf{   capture field_id aliases from corpus text    }                   ║
╠════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                        ║
║  \textbf{INPUTS:}                                                                               ║
║    • Elasticsearch index (from Stage 0)                                                ║
║    • Field ID Aliases: feature_alias_map.json (from Stage 1)                           ║
║    • Pre-computed feature embeddings (from ukb_fields titles)                          ║
║                                                                                        ║
║  \textbf{FOR EACH feature_id in alias_map:  }                                                   ║
║                                                                                        ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │ \textbf{ STEP 1: Search Elasticsearch (Match 1)   }                                       │  ║
║  │  ──────────────────────────────────────────────────────────────────────────────  │  ║
║  │                                                                                  │  ║
║  │  \textbf{Query structure:}                                                                │  ║
║  │    \textbraceleft{\textbraceright{}                                                                             │  ║
║  │      "query": \textbraceleft{\textbraceright{}                                                                  │  ║
║  │        "bool": \textbraceleft{\textbraceright{}                                                                 │  ║
║  │          "must": [                                                               │  ║
║  │            \textbraceleft{\textbraceright{}"terms": \textbraceleft{\textbraceright{}"source_type": searchable_sections\textbraceright{}\textbraceright{},                      │  ║
║  │            \textbraceleft{\textbraceright{}"bool": \textbraceleft{\textbraceright{}                                                            │  ║
║  │              "should": [                                                         │  ║
║  │                \textbraceleft{\textbraceright{}"match_phrase": \textbraceleft{\textbraceright{}"text_lower": "bmi"\textbraceright{}\textbraceright{},                          │  ║
║  │                \textbraceleft{\textbraceright{}"match_phrase": \textbraceleft{\textbraceright{}"text_lower": "body mass index"\textbraceright{}\textbraceright{},              │  ║
║  │                ...                                                               │  ║
║  │              ], "minimum_should_match": 1                                        │  ║
║  │            \textbraceright{}\textbraceright{}                                                                    │  ║
║  │          ]                                                                       │  ║
║  │        \textbraceright{}                                                                         │  ║
║  │      \textbraceright{},                                                                          │  ║
║  │      "aggs": \textbraceleft{\textbraceright{}                                                                   │  ║
║  │        "papers": \textbraceleft{\textbraceright{}                                                               │  ║
║  │          "terms": \textbraceleft{\textbraceright{}"field": "doc_id", "size": 100000\textbraceright{},                           │  ║
║  │          "aggs": \textbraceleft{\textbraceright{}"sample_contexts": \textbraceleft{\textbraceright{}"top_hits": \textbraceleft{\textbraceright{}"size": 100\textbraceright{}\textbraceright{}\textbraceright{}                │  ║
║  │        \textbraceright{}                                                                         │  ║
║  │      \textbraceright{}                                                                           │  ║
║  │    \textbraceright{}                                                                             │  ║
║  │                                                                                  │  ║
║  │  \textbf{Returns:} Grouped by paper_id, with contexts + FULL BBOX provenance              │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                        │                                               ║
║                                        ▼                                               ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │  \textbf{STEP 2: Deterministic Alias Matching (Match 2) }                                 │  ║
║  │  ──────────────────────────────────────────────────────────────────────────────  │  ║
║  │                                                                                  │  ║
║  │  \textbf{TWO-PASS MATCHING (for bbox derivation): }                                       │  ║
║  │                                                                                  │  ║
║  │  \textbf{PASS 1: Word-Sequence Match (exact bbox mapping)}                                │  ║
║  │    • Normalize: "BMI" ▶ "bmi", strip punctuation                                 │  ║
║  │    • Find alias token sequence in word_texts array                               │  ║
║  │    • Map to word_token_ids + word_bboxes (1:1 alignment)                         │  ║
║  │    • bbox_confidence: "exact"                                                    │  ║
║  │                                                                                  │  ║
║  │  \textbf{PASS 2: Char-Offset Fallback (approximate bbox) }                                │  ║
║  │    • For OCR/punctuation recovery (e.g., "year-age" matches "year/age")          │  ║
║  │    • Uses word_char_starts/word_char_ends for span mapping                       │  ║
║  │    • char_offset_safety (min_alias_len_for_char_offset: 5)                       │  ║
║  │    • bbox_confidence: "approximate"                                              │  ║
║  │                                                                                  │  ║
║  │  \textbf{CENTER-LINE CATCHING (for windowed docs): }                                      │  ║
║  │    • Only accept matches overlapping center_line_index                           │  ║
║  │    • Side-line matches filtered out (prevents duplicates)                        │  ║
║  │                                                                                  │  ║
║  │  \textbf{OVERLAP RESOLUTION: }                                                            │  ║
║  │    • Longer alias wins ▶ earlier position ▶ lexicographic                        │  ║
║  │    • Non-overlapping matches selected                                            │  ║
║  │                                                                                  │  ║
║  │  \textbf{Output per match:}                                                               │  ║
║  │    matched_alias, matched_alias_word_token_ids, matched_alias_word_bboxes        │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                        │                                               ║
║                                        ▼                                               ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │  \textbf{STEP 3: Score Context with Dynamic Thresholds (Match 3: HARD) }                  │  ║
║  │  ──────────────────────────────────────────────────────────────────────────────  │  ║
║  │                                                                                  │  ║
║  │  \textbf{BUILD CONTEXT SNIPPET (±N words around alias):}                                  │  ║
║  │    context_window.single_word_alias: 3                                           │  ║
║  │    context_window.multi_word_alias: 3                                            │  ║
║  │   "The mean BMI was 25.3" ▶ snippet: "mean BMI was 25.3"                         │  ║
║  │                                                                                  │  ║
║  │  \textbf{GET DYNAMIC THRESHOLD (get_threshold_for_alias): }                               │  ║
║  │  ┌────────────────────────────────────────────────────────────────────────────┐  │  ║
║  │  │  \textbf{ALIAS TYPE                     │ THRESHOLD │ REASON     }                  │  │  ║
║  │  │  ───────────────────────────────────────────────────────────────────────── │  │  ║
║  │  │  Field ID pattern               │   0.40   │  Highly trusted (explicit)    │  │  ║
║  │  │  e.g., "field 21001", "ukb:401" │          │                               │  │  ║
║  │  │                                 │          │                               │  │  ║
║  │  │  1-2 char acronym               │   0.82   │  Very strict ("P", "BP")      │  │  ║
║  │  │                                 │          │                               │  │  ║
║  │  │  3 char acronym                 │   0.68   │  Moderately strict ("BMI")    │  │  ║
║  │  │                                 │          │                               │  │  ║
║  │  │  4+ char acronym                │   0.62   │  Normal ("COPD", "ADHD")      │  │  ║
║  │  │                                 │          │                               │  │  ║
║  │  │  Regular alias                  │   0.62   │  Base threshold               │  │  ║
║  │  │  e.g., "body mass index"        │          │                               │  │  ║
║  │  └────────────────────────────────────────────────────────────────────────────┘  │  ║
║  │                                                                                  │  ║
║  │ \textbf{ COMPUTE EMBEDDING SIMILARITY:  }                                                 │  ║
║  │    feature_embedding = MedCPT-Query-Encoder("Body mass index (BMI)")             │  ║
║  │    context_embedding = MedCPT-Article-Encoder("mean BMI was 25.3")               │  ║
║  │    score = dot_product(feature_embedding, context_embedding)                     │  ║
║  │                                                                                  │  ║
║  │  \textbf{WITNESS ENSEMBLE SCORING: }                                                      │  ║
║  │    primary (MedCPT): 0.82, biobert_stsb: 0.79                                    │  ║
║  │    combined = 0.70 * 0.82 + 0.30 * 0.79 = 0.811                                  │  ║
║  │    quorum: k_of_n=1 must clear low_threshold (0.40)                              │  ║
║  │                                                                                  │  ║
║  │  \textbf{APPLY THRESHOLD:   }                                                             │  ║
║  │    if combined >= alias_threshold: keep                                          │  ║
║  │    else if max(model_scores) >= low_threshold: keep (fallback strategy: "max")   │  ║
║  │    else: reject (score = 0.0)                                                    │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                        │                                               ║
║                                        ▼                                               ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │  \textbf{STEP 4: Dual-Anchor Validation (Match 4: long aliases BM25 Score)     }          │  ║
║  │  ─────────────────────────────────────────────────────────────────────────────   │  ║
║  │                                                                                  │  ║
║  │  dual_anchor.enabled: true                                                       │  ║
║  │  dual_anchor.min_alias_length_for_dual_anchor: 6                                 │  ║
║  │  dual_anchor.bm25_threshold: 0.30                                                │  ║
║  │  dual_anchor.combine_strategy: "require_both"                                    │  ║
║  │                                                                                  │  ║
║  │  \textbf{For aliases >= 6 chars, require BOTH:}                                           │  ║
║  │    Anchor 1: BM25 normalized >= 0.30                                             │  ║
║  │    Anchor 2: Embedding score >= threshold                                        │  ║
║  │                                                                                  │  ║
║  │  \textbf{bm25_normalized} = log(1 + bm25) / log(1 + max_bm25_in_paper)                    │  ║
║  │                                                                                  │  ║
║  │  \textbf{If EITHER fails:} bm25_rejected=True, score=0.0 (but kept for debug)             │  ║
║  │                                                                                  │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                        │                                               ║
║                                        ▼                                               ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │  \textbf{STEP 5: Window Propagation ( Match 5: short field IDs)    }                      │  ║
║  │  ─────────────────────────────────────────────────────────────────────────────   │  ║
║  │                                                                                  │  ║
║  │  \textbf{When trusted match (is_hard_match=True) found: }                                 │  ║
║  │    1. Find anchor at line L258 (e.g., "field 95")                                │  ║
║  │    2. Query ES for lines [L256, L257, L258, L259, L260]                          │  ║
║  │    3. Search for risky patterns: "(95)", "[95]", "#\textbraceleft{\textbraceright{}95\textbraceright{}"                         │  ║
║  │    4. If found at L260 → expand frontier and repeat                              │  ║
║  │    5. Score propagated matches against feature embedding                         │  ║
║  │                                                                                  │  ║
║  │  \textbf{window_propagation.window_radius:} 2                                             │  ║
║  │  \textbf{window_propagation.max_iterations:} 3                                            │  ║
║  │  \textbf{window_propagation.min_embedding_score:} 0.70                                    │  ║
║  │                                                                                  │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                        │                                               ║
║                                        ▼                                               ║
║  ┌──────────────────────────────────────────────────────────────────────────────────┐  ║
║  │ \textbf{ STEP 6: Classify & Build Feature Card (Match Final Rank & Build)     }           │  ║
║  │  ──────────────────────────────────────────────────────────────────────────────  │  ║
║  │                                                                                  │  ║
║  │  \textbf{CONFIDENCE TIERS (classify_confidence):  }                                       │  ║
║  │    sampling.high_threshold: \textbf{SCORE 0.80    ▶   HIGH   }                            │  ║
║  │    sampling.mid_threshold: \textbf{ SCORE 0.60    ▶   MEDIUM }                            │  ║
║  │    sampling.low_threshold: \textbf{ SCORE 0.40    ▶   LOW }                               │  ║
║  │                            \textbf{ SCORE < 0.40  ▶   REJECTED }(not in output)           │  ║
║  │                                                                                  │  ║
║  │  \textbf{Final Feature Card contains: }                                                   │  ║
║  │    \textbraceleft{\textbraceright{}                                                                             │  ║
║  │      "field_id": "21001",                                                        │  ║
║  │      "title": "Body mass index (BMI)",                                           │  ║
║  │      "contexts": \textbraceleft{\textbraceright{}                                                               │  ║
║  │        "high": [                                                                 │  ║
║  │          \textbraceleft{\textbraceright{}                                                                       │  ║
║  │            "paper_id": "2021_Smith_10.123",                                      │  ║
║  │            "text": "The mean BMI was 25.3 kg/m2",                                │  ║
║  │            "context_snippet": "mean BMI was 25.3",  ← ACTUAL model input         │  ║
║  │            "score": 0.82,                                                        │  ║
║  │            "matched_alias": "mean bmi",                                          │  ║
║  │            "match_method": "word_sequence",                                      │  ║
║  │            "bbox_confidence": "exact",                                           │  ║
║  │            "scores_by_model": \textbraceleft{\textbraceright{}"primary":0.82, "biobert_stsb":0.79\textbraceright{},             │  ║
║  │            "is_hard_match": false,                                               │  ║
║  │            "bm25_score": 12.5,                                                   │  ║
║  │            "bm25_normalized": 0.65,                                              │  ║
║  │                                                                                  │  ║
║  │           \textbf{ ── BBOX PROVENANCE ──  }                                               │  ║
║  │            "doc_id": "2021_Smith_10.123",                                        │  ║
║  │            "page_num": 3,                                                        │  ║
║  │            "source_id": "L456",                                                  │  ║
║  │            "matched_alias_word_token_ids": ["W101", "W102"],                     │  ║ 
║  │            "matched_alias_word_bboxes": [[160,200,200,220],[210,200,250,220]]    │  ║
║  │          \textbraceright{}, ...                                                                  │  ║
║  │        ],                                                                        │  ║
║  │        "medium": [...],                                                          │  ║
║  │        "low": [...]                                                              │  ║
║  │      \textbraceright{}                                                                           │  ║
║  │    \textbraceright{}                                                                             │  ║
║  │                                                                                  │  ║
║  └──────────────────────────────────────────────────────────────────────────────────┘  ║
║                                                                                        ║
║  \textbf{RERANKING APPLIED: MedCPT Cross-Encoder Reranking }                                    ║
║    reranker.enabled: true                                                              ║
║    reranker.apply.top_k_per_paper: 50                                                  ║
║    reranker.apply.min_score_to_rerank: 0.40                                            ║
║    Uses (title, context_snippet) pairs for cross-attention scoring                     ║
║                                                                                        ║
║  \textbf{OUTPUT: }                                                                              ║
║    • feature_cards.jsonl (one line per feature)                                        ║
║    • feature_to_papers.json (inverted index: \textbraceleft{\textbraceright{}paper_id: \textbraceleft{\textbraceright{}field_id: match_data\textbraceright{}\textbraceright{})       ║
║                                                                                        ║
╚════════════════════════════════════════════════════════════════════════════════════════╝

╔════════════════════════════════════════════════════════════════════════════════════════╗
║                            \textbf{  BBOX PROVENANCE FLOW  }                                    ║
║               \textbf{(How we draw rectangles on original PDF page images)  }                   ║
╠════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                        ║
║    \textbf{1.paper.json        2.Stage 0 (ES)      3.Stage 2 (Scoring)      4.HIL Rendering}    ║
║    ────────────        ──────────────      ───────────────────      ───────────────    ║
║                    │                    │                       │                      ║
║ \textbf{lines[0]: }         │ \textbf{doc =} \textbraceleft{\textbraceright{}            │ \textbf{context =} \textbraceleft{\textbraceright{}           │   \textbf{Load page PNG: }    ║
║  text: "Mean BMI"  │   text: "Mean BMI" │   text: "Mean BMI"    │     page_3.png       ║
║  page_num: 3       │   page_num: 3      │   page_num: 3         │                      ║
║  words: [          │   word_token_ids:  │   matched_alias:      │   Parse bboxes:      ║
║   \textbraceleft{\textbraceright{}                │     ["W1","W2"]    │     "bmi"             │     [[160,200,       ║
║    token_id: "W1"  │   word_texts:      │   matched_alias_word_ │       200,220]]      ║
║    text: "Mean"    │     ["Mean","BMI"] │     token_ids:        │                      ║
║    bbox: [100,     │   word_char_starts:│      ["W2"]           │   Find word "W2":    ║
║          200,      │     [0, 5]         │   matched_alias_word_ │     [160,200,        ║
║          150,      │   word_char_ends:  │     bboxes:           │      200,220]        ║
║          220]      │     [4, 8]         │      [[160,200,       │                      ║
║   \textbraceright{},               │   word_bboxes_json:│        200,220]]      │   \textbf{Draw rectangle:}    ║
║   \textbraceleft{\textbraceright{}                │    "[[100,200,     │                       │  ┌──────────────┐    ║
║    token_id: "W2"  │       150,220],    │                       │  │   ┌─────┐    │    ║
║    text: "BMI"     │      [160,200,     │                       │  │   │ \textbf{BMI} │    │    ║
║    bbox: [160,     │       200,220]]"   │                       │  │   └─────┘    │    ║
║          200,      │      ...           │                       │  │    \textbf{Page 3 }   │    ║
║          200,      │  \textbraceright{}                 │                       │  └──────────────┘    ║
║          220]      │                    │                       │                      ║
║   \textbraceright{}                │                    │                       │                      ║
║ ]                  │                    │                       │                      ║
║                    │                    │                       │                      ║
╚════════════════════════════════════════════════════════════════════════════════════════╝


╔════════════════════════════════════════════════════════════════════════════════════════╗
║                          \textbf{  KEY CONFIGURATION SUMMARY  }                                 ║
╠════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                        ║
║  \textbf{resources.yaml (Stage 0)}         │  \textbf{feature_extraction.yaml (Stages 1-2) }             ║
║  ─────────────────────────────────┼──────────────────────────────────────────────────  ║
║  \textbf{elasticsearch: }                  │  \textbf{quality:  }                                        ║
║    index: ukb_paper_corpus        │    min_alias_hits: 1                               ║
║    number_of_shards: 1            │    min_alias_length: 2                             ║
║    bulk_size: 500                 │    max_alias_length: 300                           ║
║                                   │    min_alnum_ratio: 0.60                           ║
║  \textbf{line_windows:  }                  │    max_doc_freq_fraction: 0.70                     ║
║    window_size_lines: 3           │    max_table_dominance: 0.85                       ║
║    step_lines: 1                  │                                                    ║
║    center_line_catching: true     │  \textbf{embedding_thresholds:}                             ║
║    windowed_zones:                │    base_threshold: 0.62                            ║
║      - body                       │    acronym_1_2_char: 0.82                          ║
║      - abstract                   │    acronym_3_char: 0.68                            ║
║                                   │    acronym_4plus_char: 0.62                        ║
║  \textbf{extraction_zones:  }              │    field_id_pattern: 0.40                          ║
║    body: tags_include=[body,      │    expanded_alias_title_sim: 0.55                  ║
║           list_item]              │    expanded_alias_base_sim: 0.62                   ║
║    abstract: tags_include=        │                                                    ║
║           [abstract]              │  \textbf{collocation: }                                     ║
║    table_header: is_header=true   │    window_size: 5                                  ║
║                                   │    min_count: 25                                   ║
║  \textbf{exclusions: }                     │    top_collocates_to_check: 30                     ║
║    excluded_tags:                 │                                                    ║
║      - reference                  │  \textbf{sampling (confidence tiers):}                      ║
║      - citation                   │    high_threshold: 0.80                            ║
║      - footnote                   │    mid_threshold: 0.60                             ║
║    min_text_length: 2             │    low_threshold: 0.40                             ║
║    max_text_length: 10000         │                                                    ║
║                                   │  \textbf{dual_anchor: }                                     ║
║                                   │    min_alias_length_for_dual_anchor: 6             ║
║                                   │    bm25_threshold: 0.30                            ║
║                                   │    combine_strategy: require_both                  ║
║                                   │                                                    ║
║                                   │  \textbf{witness_scoring: }                                 ║
║                                   │    strategy: weighted_mean                         ║
║                                   │    weights: primary=0.70, biobert=0.30             ║
║                                   │    quorum: k_of_n=1                                ║
║                                   │                                                    ║
║                                   │  \textbf{embedder:} MedCPT-Query/Article-Encoder            ║
║                                   │  \textbf{witness:} BioBERT-mnli-snli-stsb                   ║
║                                   │  \textbf{reranker:} MedCPT-Cross-Encoder                    ║
║                                   │                                                    ║
╚════════════════════════════════════════════════════════════════════════════════════════╝
\end{Verbatim}
~~~



