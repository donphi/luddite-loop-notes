# Final Fusion Implementation


## Content


## 1. Objective and Scope


### 1.1 The Challenge


When we process a PDF document, we extract many different pieces of information using different tools:




<table>
  <thead>
    <tr>
      <th><strong>Tool</strong></th>
      <th><strong>What It Extracts</strong></th>
      <th><strong>Example Output</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Surya OCR</td>
      <td>Words and their positions</td>
      <td>&quot;Alzheimer&#39;s&quot; at position (100, 200)</td>
    </tr>
    <tr>
      <td>PP-Structure</td>
      <td>Page layout regions</td>
      <td>&quot;This is a text paragraph&quot; vs &quot;This is a table&quot;</td>
    </tr>
    <tr>
      <td>GROBID</td>
      <td>Paper metadata</td>
      <td>Title, authors, abstract</td>
    </tr>
    <tr>
      <td>TATR</td>
      <td>Table structure</td>
      <td>Rows, columns, cells</td>
    </tr>
    <tr>
      <td>MinerU</td>
      <td>Reading order</td>
      <td>Which paragraph comes first</td>
    </tr>
  </tbody>
</table>



The Problem: These tools work independently. They don't know about each other. We have:


- Words without knowing which paragraph they belong to
- Paragraphs without knowing what text is inside
- Tables without knowing which words are in which cell

### 1.2 The Implementation


Fusion is the process of connecting all these DAG processes together into one complete document.





~~~{=html}
<pre class="notion-ascii-diagram"><code><strong>BEFORE FUSION:                          AFTER FUSION:
</strong>┌─────────────────┐                    ┌─────────────────────────────┐
│  <strong>Scattered      │                    │  Complete Document          │
│  Pieces:</strong>        │                    │                             │
│                 │                    │  <strong>Title:</strong> &quot;Alzheimer&#39;s...&quot;    │
│  • 5000 words   │       <strong>FUSION</strong>       │    └─ tokens: [W1, W2, W3]  │
│  • 150 regions  │    ───────────►    │                             │
│  • 4 tables     │                    │  <strong>Abstract</strong>: &quot;We studied...&quot;  │
│  • 1 title      │                    │    └─ tokens: [L10...L50]   │
│  • 1 abstract   │                    │                             │
│                 │                    │  <strong>Table 1:</strong>                   │
│ (not connected) │                    │    └─ cells with text       │
└─────────────────┘                    └─────────────────────────────┘
</code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
\textbf{BEFORE FUSION:                          AFTER FUSION:
}┌─────────────────┐                    ┌─────────────────────────────┐
│  \textbf{Scattered      │                    │  Complete Document          │
│  Pieces:}        │                    │                             │
│                 │                    │  \textbf{Title:} "Alzheimer's..."    │
│  • 5000 words   │       \textbf{FUSION}       │    └─ tokens: [W1, W2, W3]  │
│  • 150 regions  │    ───────────►    │                             │
│  • 4 tables     │                    │  \textbf{Abstract}: "We studied..."  │
│  • 1 title      │                    │    └─ tokens: [L10...L50]   │
│  • 1 abstract   │                    │                             │
│                 │                    │  \textbf{Table 1:}                   │
│ (not connected) │                    │    └─ cells with text       │
└─────────────────┘                    └─────────────────────────────┘

\end{Verbatim}
~~~




### 1.3 Fusion Components


This process handles the following DAG fusion groups


- ✅ G2: Spine Creation (word tokens, line tokens, formulas (latex), general layout, general tables, reading order)
- ✅ G4: Metadata (doi number, journal title, references)
- ✅ G5: Table Data (table structure, cell structure)
- ✅ G6: Layout sequence (paragraphs, titles, sub titles, figures, tables, references)

---


## 2. Methods and Process


### 2.1 Two-Stage Approach


We split fusion into two stages for reliability:


- **Scaffolding:** Connecting all the unique IDs, Keys and Foreign keys without any text or table content
- **Build:** Using the Scaffolding to add te content that was purposely excluded from the Scaffolding.



~~~{=html}
<pre class="notion-ascii-diagram"><code>┌──────────────────────────────────────────────────────────────────────┐
│                         <strong>G7 FUSION PIPELINE   </strong>                        │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   <strong>STAGE 1: G7_00 SCAFFOLD  </strong>                                          │
│   ─────────────────────────                                          │
│   • Build connections (no text)                                      │
│   • Create index: &quot;Word W56 belongs to Region R1_0&quot;                  │
│   • 100% deterministic (same input = same output)                    │
│                                                                      |
|                           │                                          |
│                           ▼                                          │
│                                                                      │
│   <strong>STAGE 2: G7_01 BUILD </strong>                                              │
│   ────────────────────                                               │
│   • Add actual text content                                          │
│   • &quot;Word W56 = &#39;Alzheimer&#39;s&#39;&quot;                                       │
│   • Produce final document                                           │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘</code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
┌──────────────────────────────────────────────────────────────────────┐
│                         \textbf{G7 FUSION PIPELINE   }                        │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   \textbf{STAGE 1: G7_00 SCAFFOLD  }                                          │
│   ─────────────────────────                                          │
│   • Build connections (no text)                                      │
│   • Create index: "Word W56 belongs to Region R1_0"                  │
│   • 100% deterministic (same input = same output)                    │
│                                                                      |
|                           │                                          |
│                           ▼                                          │
│                                                                      │
│   \textbf{STAGE 2: G7_01 BUILD }                                              │
│   ────────────────────                                               │
│   • Add actual text content                                          │
│   • "Word W56 = 'Alzheimer's'"                                       │
│   • Produce final document                                           │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
\end{Verbatim}
~~~








❓ Why two stages?







### 2.2 Input Data Sources


G7_00 receives data from 6 upstream stages:





~~~{=html}
<pre class="notion-ascii-diagram"><code>                            ┌─────────────────────────┐
                            │         <strong>G7_00           │
                            │    Fusion Scaffold </strong>     │
                            │                         │
                            │  • Centroid matching    │
                            │  • FK index building    │
                            │  • Formula integration  │
                            └───────────┬─────────────┘
                                        │
    ┌───────────┬───────────┬───────────┼───────────┬───────────┬───────────┐
    │           │           │           │           │           │           │
    ▼           ▼           ▼           ▼           ▼           ▼           ▼
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│ <strong>G2_00  │  │ G2_01  │  │ G2_02  │  │ G2_04  │  │ G4_02  │  │ G5_02  │  │ G6_00 </strong> │
│Formulas│  │ Lines  │  │ Words  │  │Reading │  │ Header │  │ Tables │  │Regions │
│ (LaTeX)│  │Tokens  │  │Tokens  │  │ Order  │  │ Align  │  │ Cells  │  │  (PP)  │
└────────┘  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘
    │           │           │           │           │           │            │
    ▼           ▼           ▼           ▼           ▼           ▼            ▼
  LaTeX       Lines +      5000+       Page       Title &amp;     Table       Layout
 formulas   formula_ids    words     sequence    Abstract   cells with     boxes
   per         per         with       (voted     token_ids   word_ids     (text,
  page         page      positions   decision)                             table,
                                                                          figure)</code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
                            ┌─────────────────────────┐
                            │         \textbf{G7_00           │
                            │    Fusion Scaffold }     │
                            │                         │
                            │  • Centroid matching    │
                            │  • FK index building    │
                            │  • Formula integration  │
                            └───────────┬─────────────┘
                                        │
    ┌───────────┬───────────┬───────────┼───────────┬───────────┬───────────┐
    │           │           │           │           │           │           │
    ▼           ▼           ▼           ▼           ▼           ▼           ▼
┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐
│ \textbf{G2_00  │  │ G2_01  │  │ G2_02  │  │ G2_04  │  │ G4_02  │  │ G5_02  │  │ G6_00 } │
│Formulas│  │ Lines  │  │ Words  │  │Reading │  │ Header │  │ Tables │  │Regions │
│ (LaTeX)│  │Tokens  │  │Tokens  │  │ Order  │  │ Align  │  │ Cells  │  │  (PP)  │
└────────┘  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘
    │           │           │           │           │           │            │
    ▼           ▼           ▼           ▼           ▼           ▼            ▼
  LaTeX       Lines +      5000+       Page       Title &     Table       Layout
 formulas   formula_ids    words     sequence    Abstract   cells with     boxes
   per         per         with       (voted     token_ids   word_ids     (text,
  page         page      positions   decision)                             table,
                                                                          figure)
\end{Verbatim}
~~~




### 2.3 The Connection Method: Centroid Containment


How do we know which words belong to which region?



We use a simple geometric rule called centroid containment:





~~~{=html}
<pre class="notion-ascii-diagram"><code><strong>Step 1:</strong> Find the center of each word&#39;s bounding box

    Word &quot;Alzheimer&#39;s&quot;
    ┌─────────────────┐
    │                 │
    │        •        │  ◄── Center point (centroid)
    │                 │
    └─────────────────┘

<strong>Step 2:</strong> Check if the center is inside a region

    Region R1_0 (text paragraph)
    ┌───────────────────────────────────┐
    │                                   │
    │   Word 1    Word 2    Word 3      │
    │     •         •         •         │  
    │                                   │  ◄── All centers inside = belongs here
    │   Word 4    Word 5                │
    │     •         •                   │
    │                                   │
    └───────────────────────────────────┘

--Centroid

<strong>Distance-IoU Loss: Faster and Better Learning for Bounding Box Regression. Zheng et al. (2020)</strong></code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
\textbf{Step 1:} Find the center of each word's bounding box

    Word "Alzheimer's"
    ┌─────────────────┐
    │                 │
    │        •        │  ◄── Center point (centroid)
    │                 │
    └─────────────────┘

\textbf{Step 2:} Check if the center is inside a region

    Region R1_0 (text paragraph)
    ┌───────────────────────────────────┐
    │                                   │
    │   Word 1    Word 2    Word 3      │
    │     •         •         •         │  
    │                                   │  ◄── All centers inside = belongs here
    │   Word 4    Word 5                │
    │     •         •                   │
    │                                   │
    └───────────────────────────────────┘

--Centroid

\textbf{Distance-IoU Loss: Faster and Better Learning for Bounding Box Regression. Zheng et al. (2020)}
\end{Verbatim}
~~~








Why this method?


- ✅ Simple and fast
- ✅ No thresholds to tune
- ✅ 100% deterministic
- ✅ ~98% accuracy on academic papers

### 2.4 Complete Data Flow




~~~{=html}
<pre class="notion-ascii-diagram"><code>┌─────────────────────────────────────────────────────────────────────────┐
│                        <strong>COMPLETE FUSION FLOW </strong>                            │
└─────────────────────────────────────────────────────────────────────────┘

<strong>INPUT FILES:                          G7_00 SCAFFOLD:
</strong>─────────────                         ───────────────

<strong>spine/line_tokens.jsonl</strong> ─────────┐
  (lines with formula_ids)       │
                                 │
<strong>spine/word_tokens.jsonl</strong> ─────────┤
  (words with positions)         │
                                 │
<strong>spine/reading_order_voted.json</strong>   |───► scaffold.json
  (page order decisions)         │      │
                                 │      │ <strong>Contains:</strong>
<strong>hierarchy/fused_layout_tokens</strong> ───┤      │ • header.title_token_ids
  (regions→lines→words)          │      │ • header.abstract_token_ids
                                 │      │ • pages[].regions[].token_ids
<strong>tabular/tables.jsonl</strong> ────────────┤      │ • pages[].tables[].cells[].token_ids
  (cells→word mappings)          │      │ • formulas.latex{}
                                 │      │
<strong>header/alignment.json</strong> ───────────┤      ▼
  (title/abstract tokens)        │
                                 │    <strong>G7_01 BUILD:</strong>
<strong>surya/formulas/</strong> ─────────────────┘    ─────────────
  (LaTeX content)
                                      candidate.json
                                        │
                                        │ <strong>Contains:</strong>
                                        │ • header.title = &quot;Full title text&quot;
                                        │ • pages[].regions[].text = &quot;...&quot;
                                        │ • pages[].tables[].cells[].text = &quot;...&quot;
                                        │ • formulas[].latex = &quot;\\\\frac{x}{y}&quot;
                                        ▼

                                      <strong>FINAL DOCUMENT</strong></code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
┌─────────────────────────────────────────────────────────────────────────┐
│                        \textbf{COMPLETE FUSION FLOW }                            │
└─────────────────────────────────────────────────────────────────────────┘

\textbf{INPUT FILES:                          G7_00 SCAFFOLD:
}─────────────                         ───────────────

\textbf{spine/line_tokens.jsonl} ─────────┐
  (lines with formula_ids)       │
                                 │
\textbf{spine/word_tokens.jsonl} ─────────┤
  (words with positions)         │
                                 │
\textbf{spine/reading_order_voted.json}   |───► scaffold.json
  (page order decisions)         │      │
                                 │      │ \textbf{Contains:}
\textbf{hierarchy/fused_layout_tokens} ───┤      │ • header.title_token_ids
  (regions→lines→words)          │      │ • header.abstract_token_ids
                                 │      │ • pages[].regions[].token_ids
\textbf{tabular/tables.jsonl} ────────────┤      │ • pages[].tables[].cells[].token_ids
  (cells→word mappings)          │      │ • formulas.latex\textbraceleft{\textbraceright{}\textbraceright{}
                                 │      │
\textbf{header/alignment.json} ───────────┤      ▼
  (title/abstract tokens)        │
                                 │    \textbf{G7_01 BUILD:}
\textbf{surya/formulas/} ─────────────────┘    ─────────────
  (LaTeX content)
                                      candidate.json
                                        │
                                        │ \textbf{Contains:}
                                        │ • header.title = "Full title text"
                                        │ • pages[].regions[].text = "..."
                                        │ • pages[].tables[].cells[].text = "..."
                                        │ • formulas[].latex = "\textbackslash\textbraceleft{\textbraceright{}\textbraceright{}\textbackslash\textbraceleft{\textbraceright{}\textbraceright{}\textbackslash\textbraceleft{\textbraceright{}\textbraceright{}\textbackslash\textbraceleft{\textbraceright{}\textbraceright{}frac\textbraceleft{\textbraceright{}x\textbraceright{}\textbraceleft{\textbraceright{}y\textbraceright{}"
                                        ▼

                                      \textbf{FINAL DOCUMENT}
\end{Verbatim}
~~~




### 2.5 Output Schema


The final candidate.json structure:





~~~json
{
  "doc_id": "paper_12345",
  "total_pages": 10,

  "header": {
    "title": "Genetic risk score for Alzheimer's disease...",
    "title_token_ids": ["W9", "W10", "W11", ...],
    "abstract": "INTRODUCTION: We estimated the ages...",
    "abstract_token_ids": ["W100", "W101", ...]
  },

  "formulas": {
    "total_formulas": 5,
    "latex": {
      "F1": "\\\\beta = 0.45",
      "F2": "p < 0.001"
    }
  },

  "pages": [
    {
      "page_num": 1,
      "reading_order": {
        "decision": "mineru",
        "line_indices": [0, 1, 2, 3, ...]
      },
      "regions": [
        {
          "id": "R1_0",
          "type": "text",
          "text": "The full paragraph text...",
          "token_ids": ["W56", "W57", ...],
          "formula_ids": ["F1"]
        }
      ],
      "tables": [
        {
          "table_id": "T1",
          "cells": [
            {
              "cell_id": "T1_R0C0",
              "row_idx": 0,
              "col_idx": 0,
              "text": "Characteristic",
              "token_ids": ["W3246"]
            }
          ]
        }
      ]
    }
  ]
}

~~~




---


## 3. Key Technical Outcomes


### 3.1 Metrics Tracked



<table>
  <thead>
    <tr>
      <th><strong>Metric</strong></th>
      <th><strong>Description</strong></th>
      <th><strong>Target</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Region Coverage</td>
      <td>% of regions with matched lines</td>
      <td>&gt;95%</td>
    </tr>
    <tr>
      <td>Line Coverage</td>
      <td>% of lines assigned to regions</td>
      <td>&gt;90%</td>
    </tr>
    <tr>
      <td>Token Coverage</td>
      <td>% of words in regions or tables</td>
      <td>&gt;95%</td>
    </tr>
    <tr>
      <td>Hydration Rate</td>
      <td>% of token IDs successfully resolved to text</td>
      <td>&gt;99%</td>
    </tr>
    <tr>
      <td>Orphan Lines</td>
      <td>Lines not in any region</td>
      <td>&lt;10%</td>
    </tr>
    <tr>
      <td>Orphan Tokens</td>
      <td>Words not in any region or table</td>
      <td>&lt;5%</td>
    </tr>
  </tbody>
</table>



### 3.2 Example Output Metrics




~~~{=html}
<pre class="notion-ascii-diagram"><code><strong>Scaffold Metrics (G7_00):
</strong>─────────────────────────
  <strong>total_regions:</strong> 150
  <strong>regions_with_lines:</strong> 145
  <strong>regions_without_lines:</strong> 5
  <strong>region_coverage_pct:</strong> 0.9667

  <strong>total_lines:</strong> 500
  <strong>lines_in_regions:</strong> 490
  <strong>orphan_lines: </strong>10
  <strong>line_coverage_pct:</strong> 0.98

  <strong>total_tokens:</strong> 5000
  <strong>tokens_in_regions:</strong> 4950
  <strong>orphan_tokens:</strong> 50
  <strong>token_coverage_pct:</strong> 0.99

  <strong>total_tables:</strong> 4
  <strong>total_cells:</strong> 120
  <strong>total_formula_refs:</strong> 8

<strong>Build Metrics (G7_01):
</strong>──────────────────────
  <strong>total_tokens_hydrated:</strong> 5000
  <strong>total_tokens_missing:</strong> 12
  <strong>hydration_rate_pct:</strong> 99.76
  <strong>header_title_chars:</strong> 85
  <strong>header_abstract_chars:</strong> 1200</code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
\textbf{Scaffold Metrics (G7_00):
}─────────────────────────
  \textbf{total_regions:} 150
  \textbf{regions_with_lines:} 145
  \textbf{regions_without_lines:} 5
  \textbf{region_coverage_pct:} 0.9667

  \textbf{total_lines:} 500
  \textbf{lines_in_regions:} 490
  \textbf{orphan_lines: }10
  \textbf{line_coverage_pct:} 0.98

  \textbf{total_tokens:} 5000
  \textbf{tokens_in_regions:} 4950
  \textbf{orphan_tokens:} 50
  \textbf{token_coverage_pct:} 0.99

  \textbf{total_tables:} 4
  \textbf{total_cells:} 120
  \textbf{total_formula_refs:} 8

\textbf{Build Metrics (G7_01):
}──────────────────────
  \textbf{total_tokens_hydrated:} 5000
  \textbf{total_tokens_missing:} 12
  \textbf{hydration_rate_pct:} 99.76
  \textbf{header_title_chars:} 85
  \textbf{header_abstract_chars:} 1200
\end{Verbatim}
~~~




### 3.3 Determinism Guarantee


The fusion process is 100% deterministic:





~~~{=html}
<pre class="notion-ascii-diagram"><code>Same PDF → Same scaffold.json → Same candidate.json
                    ↓
           Always reproducible
</code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
Same PDF → Same scaffold.json → Same candidate.json
                    ↓
           Always reproducible

\end{Verbatim}
~~~




This is critical for:


- Scientific reproducibility
- Debugging
- Audit trails
- Quality control

---


## 4. Critical Reflection


### 4.1 Strengths



<table>
  <thead>
    <tr>
      <th><strong>Aspect</strong></th>
      <th><strong>Strength</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Simplicity</strong></td>
      <td>Centroid containment is easy to understand and verify</td>
    </tr>
    <tr>
      <td><strong>Speed</strong></td>
      <td>No ML inference, pure geometry, processes ~50 pages/second</td>
    </tr>
    <tr>
      <td><strong>Reproducibility</strong></td>
      <td>100% deterministic, same input always gives same output</td>
    </tr>
    <tr>
      <td><strong>Modularity</strong></td>
      <td>Two-stage design allows independent validation</td>
    </tr>
    <tr>
      <td><strong>Scalability</strong></td>
      <td>No state between documents, scales to 100,000+</td>
    </tr>
  </tbody>
</table>



### 4.2 Weaknesses and Risks



<table>
  <thead>
    <tr>
      <th><strong>Risk</strong></th>
      <th><strong>Impact</strong></th>
      <th><strong>Mitigation</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Region detection errors</strong></td>
      <td>Words assigned to wrong region</td>
      <td>Upstream QC in G6_02</td>
    </tr>
    <tr>
      <td><strong>Orphan tokens</strong></td>
      <td>Some words not in any region</td>
      <td>Track and report in metrics</td>
    </tr>
    <tr>
      <td><strong>Formula parsing</strong></td>
      <td>LaTeX may be incomplete</td>
      <td>Fallback to placeholder</td>
    </tr>
    <tr>
      <td><strong>Complex layouts</strong></td>
      <td>Overlapping regions may confuse matching</td>
      <td>Use PP-Structure confidence</td>
    </tr>
  </tbody>
</table>



### 4.3 Maintenance Concerns


Complexity Level: MODERATE



The fusion pipeline depends on 6 upstream stages. Changes to any of them may require updates here:





~~~{=html}
<pre class="notion-ascii-diagram"><code><strong>Dependency Chain:
</strong>─────────────────

<strong>G2_01</strong> (line_tokens) ──┐
                      │
<strong>G2_04</strong> (reading_order) ┤
                      │
<strong>G4_02</strong> (header) ───────┤───► <strong>G7_00 ─► G7_01</strong>
                      │
<strong>G5_02</strong> (tables) ───────┤
                      │
<strong>G6_03</strong> (layout) ───────┘</code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
\textbf{Dependency Chain:
}─────────────────

\textbf{G2_01} (line_tokens) ──┐
                      │
\textbf{G2_04} (reading_order) ┤
                      │
\textbf{G4_02} (header) ───────┤───► \textbf{G7_00 ─► G7_01}
                      │
\textbf{G5_02} (tables) ───────┤
                      │
\textbf{G6_03} (layout) ───────┘
\end{Verbatim}
~~~








### 4.4 What Could Go Wrong?

1. **Upstream stage fails silently** → Missing input file
    - _Mitigation:_ Validate all inputs exist before processing
2. **Token ID format changes** → FK lookups fail
    - _Mitigation:_ Standardize token ID format (e.g., "W1234")
3. **Region bbox coordinates mismatch** → Wrong assignments
    - _Mitigation:_ Verify page dimensions match between sources

---


## 5. Next Steps


### Future Considerations


⛔ AUDIT STAGE 8: CANCELLED FOR DISSERTATION


1. ~~**G8 Audit Stage**~~
    - ~~Compare fused text against witness OCR (Marker, Docling)~~
    - ~~Build confidence scores for each region~~
2. **G9 Canonical Export**
    - Convert candidate.json to final paper.json
    - Apply audit corrections








