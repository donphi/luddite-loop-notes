# hard matches


## Content


# Hard Match Strategy for Field IDs and Titles


## 1. The Core Design Decision


### What is a "Hard Match"?


A hard match is when the matched text provides unambiguous, deterministic evidence of the feature being referenced. These matches bypass semantic scoring because:





~~~{=html}
<pre class="notion-ascii-diagram"><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                   <strong>        HARD MATCH PHILOSOPHY       </strong>                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   <strong>SOFT MATCH (needs semantic scoring): </strong>                                     │
│   ────────────────────────────────────                                      │
│   &quot;systolic arterial pressure&quot;  ──❓──►  Field 4080: &quot;Systolic blood        │
│                                         pressure, automated reading&quot;        │
│                                                                             │
│  <strong> WHY:</strong> The alias is semantically similar but NOT identical.                 │
│        We need embedding similarity to confirm relevance.                   │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   <strong>HARD MATCH (bypass semantic scoring):   </strong>                                  │
│   ─────────────────────────────────────                                     │
│   &quot;ukb field 4080&quot;              ── ✅ ──►  Field 4080                       │
│   &quot;data-field 4080&quot;             ── ✅ ──►  Field 4080                       │
│   &quot;Systolic blood pressure...&quot;  ── ✅ ──►  Field 4080 (exact title)         │
│                                                                             │
│   <strong>WHY:</strong> The reference IS the identifier or exact title.                      │
│        Semantic scoring adds no information - it&#39;s already certain.         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
┌─────────────────────────────────────────────────────────────────────────────┐
│                   \textbf{        HARD MATCH PHILOSOPHY       }                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   \textbf{SOFT MATCH (needs semantic scoring): }                                     │
│   ────────────────────────────────────                                      │
│   "systolic arterial pressure"  ──❓──►  Field 4080: "Systolic blood        │
│                                         pressure, automated reading"        │
│                                                                             │
│  \textbf{ WHY:} The alias is semantically similar but NOT identical.                 │
│        We need embedding similarity to confirm relevance.                   │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   \textbf{HARD MATCH (bypass semantic scoring):   }                                  │
│   ─────────────────────────────────────                                     │
│   "ukb field 4080"              ── ✅ ──►  Field 4080                       │
│   "data-field 4080"             ── ✅ ──►  Field 4080                       │
│   "Systolic blood pressure..."  ── ✅ ──►  Field 4080 (exact title)         │
│                                                                             │
│   \textbf{WHY:} The reference IS the identifier or exact title.                      │
│        Semantic scoring adds no information - it's already certain.         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

\end{Verbatim}
~~~




---


## 2. Decision Tree: How Hard Matching Works




~~~{=html}
<pre class="notion-ascii-diagram"><code>┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                  <strong>                   HARD MATCH DECISION TREE                                    </strong>│<strong>
</strong>│<strong>      </strong>                               (<strong>field_id &amp; field_title)                                    </strong>│
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

                           <strong>Matched Span from ES</strong>
                                    │
                                    ▼
               ┌───────────────────────────────────────────┐
               │       <strong>  STAGE 1: FIELD ID PATTERNS </strong>       │
               │         ──────────────────────────        │
               │  Check if span matches any template:      │
               │  • &quot;field {id}&quot;, &quot;ukb {id}&quot;, &quot;code {id}&quot;  │
               │  • &quot;data-field {id}&quot;, &quot;ukb-{id}&quot;          │
               │  • ... (40+ safe patterns)                │
               └───────────────────┬───────────────────────┘
                                   │
                       ┌───────────┴───────────────┐
                       │                           │
                  <strong>   MATCH                      NO MATCH</strong>
                  (<strong>field_id)</strong>               <strong>(Check field_title)</strong>
                       │                           │
                       ▼                           ▼
              ┌────────────────┐    ┌──────────────────────────────┐
              │  <strong>is_hard_match │    │   STAGE 2: TITLE MATCHING    │
              │     = TRUE</strong>     │    │   ─────────────────────────  │
              │ BYPASS semantic│    │   Compare span to feature    │
              │    scoring     │    │   title after normalization  │
              └────────────────┘    └──────────────┬───────────────┘
                                                   │
                                                   ▼
                               ┌──────────────────────────────────────┐
                               │            <strong> TITLE GUARD </strong>             │
                               │ prevent short-alias false positives  │
                               │                                      │
                               │   Single token → min 8 chars         │
                               │   Multi token  → min 2 tokens        │
                               └──────────────────┬───────────────────┘
                                                  │
                                  ┌───────────────┴───────────────┐
                                  │                               │
                          <strong>       PASS                             </strong>│
                                  │                               │
                      ┌───────────┴───────────┐                   │
                      │  <strong>Normalize &amp; Compare</strong>  │                   │
                      │  ───────────────────  │                  <strong>FAIL</strong>
                      │  &quot;C-reactive protein&quot; │                   │
                      │          ▼            │                   │
                      │   &quot;creactiveprotein&quot;  │                   │
                      │          =            │                   │
                      │   title normalized    │                   │
                      └───────────┬───────────┘          ┌────────┘
                                  │                      │
                      ┌───────────┴───────────┐          │
                      │                       │          │
                    <strong>EQUAL</strong>                 <strong>NOT EQUAL </strong>     │
                      │                       │          │
                      ▼                       ▼          ▼
              ┌────────────────┐     ┌──────────────────────────────┐
              │ <strong>is_hard_match  │     │   STAGE 3: TITLE ACRONYMS    │
              │    = TRUE</strong>      │     │   ────────────────────────   │
              │ (title match)  │     │   Check if span is acronym   │
              └────────────────┘     │    from title parentheses    │
                                     │                              │
                                     │   &quot;Left ventricular end      │
                                     │   diastolic volume (LVEDV)&quot;  │
                                     │                      ↓       │
                                     │   span &quot;LVEDV&quot; → HARD MATCH  │
                                     └──────────────┬───────────────┘
                                                    │
                                        ┌───────────┴───────────┐
                             <strong>         MATCH                  NO MATCH</strong>
                                        │                       │
                                        ▼                       ▼
                           ┌────────────────┐    ┌──────────────────────┐
                           │ is_hard_match  │    │  STAGE 4: STOPWORD   │
                           │     = TRUE     │    │  AFFIX MATCHING      │
                           │ (acronym)      │    │  ────────────────    │
                           └────────────────┘    │                      │
                                                 │  &quot;BMI and&quot; matches   │
                                                 │  title &quot;BMI&quot; + affix │
                                                 │  stopword &quot;and&quot;      │
                                                 └──────────┬───────────┘
                                                            │
                                                ┌───────────┴───────────┐
                                              MATCH               NO MATCH
                                                │                       │
                                                ▼                       ▼
                                       ┌────────────────┐    ┌──────────────────┐
                                       │ is_hard_match  │    │   STAGE 5:       │
                                       │     = TRUE     │    │   DERIVED ACRO   │
                                       │ (stopword)     │    │   + OVERLAP      │
                                       └────────────────┘    │                  │
                                                             │ &quot;circumference   │
                                                             │  WC&quot; matches     │
                                                             │ title &quot;Waist     │
                                                             │  circumference&quot;  │
                                                             │ (derived: WC +   │
                                                             │  token overlap)  │
                                                             └────────┬─────────┘
                                                                      │
                                                          ┌───────────┴───────────┐
                                                        MATCH               NO MATCH
                                                          │                       │
                                                          ▼                       ▼
                                                 ┌────────────────┐    ┌───────────────────┐
                                                 │ is_hard_match  │    │  is_hard_match    │
                                                 │     = TRUE     │    │     = FALSE       │
                                                 │ (combo)        │    │                   │
                                                 └────────────────┘    │  → SOFT MATCH     │
                                                                       │  → USE SEMANTIC   │
                                                                       │    SCORING        │
                                                                       └───────────────────┘
</code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
┌─────────────────────────────────────────────────────────────────────────────────────────────────┐
│                  \textbf{                   HARD MATCH DECISION TREE                                    }│\textbf{
}│\textbf{      }                               (\textbf{field_id & field_title)                                    }│
└─────────────────────────────────────────────────────────────────────────────────────────────────┘

                           \textbf{Matched Span from ES}
                                    │
                                    ▼
               ┌───────────────────────────────────────────┐
               │       \textbf{  STAGE 1: FIELD ID PATTERNS }       │
               │         ──────────────────────────        │
               │  Check if span matches any template:      │
               │  • "field \textbraceleft{\textbraceright{}id\textbraceright{}", "ukb \textbraceleft{\textbraceright{}id\textbraceright{}", "code \textbraceleft{\textbraceright{}id\textbraceright{}"  │
               │  • "data-field \textbraceleft{\textbraceright{}id\textbraceright{}", "ukb-\textbraceleft{\textbraceright{}id\textbraceright{}"          │
               │  • ... (40+ safe patterns)                │
               └───────────────────┬───────────────────────┘
                                   │
                       ┌───────────┴───────────────┐
                       │                           │
                  \textbf{   MATCH                      NO MATCH}
                  (\textbf{field_id)}               \textbf{(Check field_title)}
                       │                           │
                       ▼                           ▼
              ┌────────────────┐    ┌──────────────────────────────┐
              │  \textbf{is_hard_match │    │   STAGE 2: TITLE MATCHING    │
              │     = TRUE}     │    │   ─────────────────────────  │
              │ BYPASS semantic│    │   Compare span to feature    │
              │    scoring     │    │   title after normalization  │
              └────────────────┘    └──────────────┬───────────────┘
                                                   │
                                                   ▼
                               ┌──────────────────────────────────────┐
                               │            \textbf{ TITLE GUARD }             │
                               │ prevent short-alias false positives  │
                               │                                      │
                               │   Single token → min 8 chars         │
                               │   Multi token  → min 2 tokens        │
                               └──────────────────┬───────────────────┘
                                                  │
                                  ┌───────────────┴───────────────┐
                                  │                               │
                          \textbf{       PASS                             }│
                                  │                               │
                      ┌───────────┴───────────┐                   │
                      │  \textbf{Normalize & Compare}  │                   │
                      │  ───────────────────  │                  \textbf{FAIL}
                      │  "C-reactive protein" │                   │
                      │          ▼            │                   │
                      │   "creactiveprotein"  │                   │
                      │          =            │                   │
                      │   title normalized    │                   │
                      └───────────┬───────────┘          ┌────────┘
                                  │                      │
                      ┌───────────┴───────────┐          │
                      │                       │          │
                    \textbf{EQUAL}                 \textbf{NOT EQUAL }     │
                      │                       │          │
                      ▼                       ▼          ▼
              ┌────────────────┐     ┌──────────────────────────────┐
              │ \textbf{is_hard_match  │     │   STAGE 3: TITLE ACRONYMS    │
              │    = TRUE}      │     │   ────────────────────────   │
              │ (title match)  │     │   Check if span is acronym   │
              └────────────────┘     │    from title parentheses    │
                                     │                              │
                                     │   "Left ventricular end      │
                                     │   diastolic volume (LVEDV)"  │
                                     │                      ↓       │
                                     │   span "LVEDV" → HARD MATCH  │
                                     └──────────────┬───────────────┘
                                                    │
                                        ┌───────────┴───────────┐
                             \textbf{         MATCH                  NO MATCH}
                                        │                       │
                                        ▼                       ▼
                           ┌────────────────┐    ┌──────────────────────┐
                           │ is_hard_match  │    │  STAGE 4: STOPWORD   │
                           │     = TRUE     │    │  AFFIX MATCHING      │
                           │ (acronym)      │    │  ────────────────    │
                           └────────────────┘    │                      │
                                                 │  "BMI and" matches   │
                                                 │  title "BMI" + affix │
                                                 │  stopword "and"      │
                                                 └──────────┬───────────┘
                                                            │
                                                ┌───────────┴───────────┐
                                              MATCH               NO MATCH
                                                │                       │
                                                ▼                       ▼
                                       ┌────────────────┐    ┌──────────────────┐
                                       │ is_hard_match  │    │   STAGE 5:       │
                                       │     = TRUE     │    │   DERIVED ACRO   │
                                       │ (stopword)     │    │   + OVERLAP      │
                                       └────────────────┘    │                  │
                                                             │ "circumference   │
                                                             │  WC" matches     │
                                                             │ title "Waist     │
                                                             │  circumference"  │
                                                             │ (derived: WC +   │
                                                             │  token overlap)  │
                                                             └────────┬─────────┘
                                                                      │
                                                          ┌───────────┴───────────┐
                                                        MATCH               NO MATCH
                                                          │                       │
                                                          ▼                       ▼
                                                 ┌────────────────┐    ┌───────────────────┐
                                                 │ is_hard_match  │    │  is_hard_match    │
                                                 │     = TRUE     │    │     = FALSE       │
                                                 │ (combo)        │    │                   │
                                                 └────────────────┘    │  → SOFT MATCH     │
                                                                       │  → USE SEMANTIC   │
                                                                       │    SCORING        │
                                                                       └───────────────────┘

\end{Verbatim}
~~~




---


## 3. Concrete Examples with Your Config Values




~~~{=html}
<pre class="notion-ascii-diagram"><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                         EXAMPLE 1: FIELD ID PATTERN                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  INPUT:                                                                     │
│  ─────                                                                      │
│  Paper text: &quot;We used ukb field 4080 for blood pressure measurements&quot;      │
│  Target field: 4080 (&quot;Systolic blood pressure, automated reading&quot;)         │
│                                                                             │
│  MATCHING FLOW:                                                             │
│  ──────────────                                                             │
│                                                                             │
│    &quot;ukb field 4080&quot;                                                         │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │ Check field_id_patterns.templates│                                      │
│    │ &quot;ukb field {id}&quot; ← MATCHES!     │                                      │
│    └─────────────────────────────────┘                                      │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │      is_hard_match = TRUE       │                                      │
│    │   matched_alias = &quot;ukb field    │                                      │
│    │                    4080&quot;        │                                      │
│    │   BYPASS SEMANTIC SCORING       │                                      │
│    └─────────────────────────────────┘                                      │
│                                                                             │
│  PROVENANCE CAPTURED:                                                       │
│  ────────────────────                                                       │
│  span_text: &quot;ukb field 4080&quot;                                                │
│  span_char_start: 8                                                         │
│  span_char_end: 22                                                          │
│  span_text_method: &quot;char_offsets&quot;                                           │
│  matched_alias_word_token_ids: [3, 4, 5]                                    │
│  matched_alias_word_bboxes: [[x1,y1,x2,y2], [...], [...]]                   │
│                                                                             │
│  WHY DEFENSIBLE: The author explicitly wrote the field ID.                  │
│  An embedding model cannot add certainty beyond 100%.                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    EXAMPLE 2: EXACT TITLE MATCH                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  INPUT:                                                                     │
│  ─────                                                                      │
│  Paper text: &quot;Current tobacco smoking was assessed using...&quot;                │
│  Target field: 1239 (title: &quot;Current tobacco smoking&quot;)                      │
│                                                                             │
│  MATCHING FLOW:                                                             │
│  ──────────────                                                             │
│                                                                             │
│    span_text: &quot;Current tobacco smoking&quot;                                     │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │ Step 1: Field ID patterns?      │                                      │
│    │         NO                      │                                      │
│    └─────────────────────────────────┘                                      │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │ Step 2: Title guard check       │                                      │
│    │ Token count = 3 (≥ 2) ✓         │                                      │
│    └─────────────────────────────────┘                                      │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │ Step 3: Normalize &amp; compare     │                                      │
│    │                                 │                                      │
│    │ title:     &quot;Current tobacco     │                                      │
│    │            smoking&quot;             │                                      │
│    │      ↓ normalize                │                                      │
│    │ &quot;currenttobaccosmoking&quot;         │                                      │
│    │                                 │                                      │
│    │ span:      &quot;Current tobacco     │                                      │
│    │            smoking&quot;             │                                      │
│    │      ↓ normalize                │                                      │
│    │ &quot;currenttobaccosmoking&quot;         │                                      │
│    │                                 │                                      │
│    │ EQUAL? YES ✓                    │                                      │
│    └─────────────────────────────────┘                                      │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │      is_hard_match = TRUE       │                                      │
│    │      (is_title_match = TRUE)    │                                      │
│    └─────────────────────────────────┘                                      │
│                                                                             │
│  NORMALIZATION DETAILS:                                                     │
│  ──────────────────────                                                     │
│  _normalize_for_hard_match() strips ALL punctuation/whitespace:             │
│                                                                             │
│    &quot;Tense / &#39;highly strung&#39;&quot;  →  &quot;tensehighlystrung&quot;                        │
│    &quot;tense/&#39;highly strung&#39;,&quot;   →  &quot;tensehighlystrung&quot;                        │
│    &quot;tense/\\&quot;highly strung\\&quot;&quot;  →  &quot;tensehighlystrung&quot;                        │
│                                                                             │
│  This handles OCR artifacts and typographic variation.                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    EXAMPLE 3: TITLE ACRONYM MATCH                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  INPUT:                                                                     │
│  ─────                                                                      │
│  Paper text: &quot;LVEDV was measured using cardiac MRI&quot;                         │
│  Target field: 22420                                                        │
│  Title: &quot;Left ventricular end diastolic volume (LVEDV)&quot;                     │
│                                                                             │
│  MATCHING FLOW:                                                             │
│  ──────────────                                                             │
│                                                                             │
│    span_text: &quot;LVEDV&quot;                                                       │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │ Step 1: Field ID patterns?      │                                      │
│    │         NO                      │                                      │
│    └─────────────────────────────────┘                                      │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │ Step 2: Title exact match?      │                                      │
│    │         NO (&quot;LVEDV&quot; ≠ full      │                                      │
│    │            title)               │                                      │
│    └─────────────────────────────────┘                                      │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │ Step 3: Title acronym check     │                                      │
│    │                                 │                                      │
│    │ _extract_title_acronyms()       │                                      │
│    │ finds &quot;(LVEDV)&quot; in title        │                                      │
│    │                                 │                                      │
│    │ Config guards:                  │                                      │
│    │ • title_acronym_min_length: 4   │                                      │
│    │ • title_acronym_max_length: 15  │                                      │
│    │ • require_parentheses: true     │                                      │
│    │                                 │                                      │
│    │ &quot;LVEDV&quot; = 5 chars (4-15) ✓      │                                      │
│    │ In parentheses in title ✓       │                                      │
│    │ Span matches acronym ✓          │                                      │
│    └─────────────────────────────────┘                                      │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │      is_hard_match = TRUE       │                                      │
│    │  (is_title_acronym_match=TRUE)  │                                      │
│    └─────────────────────────────────┘                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
┌─────────────────────────────────────────────────────────────────────────────┐
│                         EXAMPLE 1: FIELD ID PATTERN                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  INPUT:                                                                     │
│  ─────                                                                      │
│  Paper text: "We used ukb field 4080 for blood pressure measurements"      │
│  Target field: 4080 ("Systolic blood pressure, automated reading")         │
│                                                                             │
│  MATCHING FLOW:                                                             │
│  ──────────────                                                             │
│                                                                             │
│    "ukb field 4080"                                                         │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │ Check field_id_patterns.templates│                                      │
│    │ "ukb field \textbraceleft{\textbraceright{}id\textbraceright{}" ← MATCHES!     │                                      │
│    └─────────────────────────────────┘                                      │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │      is_hard_match = TRUE       │                                      │
│    │   matched_alias = "ukb field    │                                      │
│    │                    4080"        │                                      │
│    │   BYPASS SEMANTIC SCORING       │                                      │
│    └─────────────────────────────────┘                                      │
│                                                                             │
│  PROVENANCE CAPTURED:                                                       │
│  ────────────────────                                                       │
│  span_text: "ukb field 4080"                                                │
│  span_char_start: 8                                                         │
│  span_char_end: 22                                                          │
│  span_text_method: "char_offsets"                                           │
│  matched_alias_word_token_ids: [3, 4, 5]                                    │
│  matched_alias_word_bboxes: [[x1,y1,x2,y2], [...], [...]]                   │
│                                                                             │
│  WHY DEFENSIBLE: The author explicitly wrote the field ID.                  │
│  An embedding model cannot add certainty beyond 100%.                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    EXAMPLE 2: EXACT TITLE MATCH                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  INPUT:                                                                     │
│  ─────                                                                      │
│  Paper text: "Current tobacco smoking was assessed using..."                │
│  Target field: 1239 (title: "Current tobacco smoking")                      │
│                                                                             │
│  MATCHING FLOW:                                                             │
│  ──────────────                                                             │
│                                                                             │
│    span_text: "Current tobacco smoking"                                     │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │ Step 1: Field ID patterns?      │                                      │
│    │         NO                      │                                      │
│    └─────────────────────────────────┘                                      │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │ Step 2: Title guard check       │                                      │
│    │ Token count = 3 (≥ 2) ✓         │                                      │
│    └─────────────────────────────────┘                                      │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │ Step 3: Normalize & compare     │                                      │
│    │                                 │                                      │
│    │ title:     "Current tobacco     │                                      │
│    │            smoking"             │                                      │
│    │      ↓ normalize                │                                      │
│    │ "currenttobaccosmoking"         │                                      │
│    │                                 │                                      │
│    │ span:      "Current tobacco     │                                      │
│    │            smoking"             │                                      │
│    │      ↓ normalize                │                                      │
│    │ "currenttobaccosmoking"         │                                      │
│    │                                 │                                      │
│    │ EQUAL? YES ✓                    │                                      │
│    └─────────────────────────────────┘                                      │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │      is_hard_match = TRUE       │                                      │
│    │      (is_title_match = TRUE)    │                                      │
│    └─────────────────────────────────┘                                      │
│                                                                             │
│  NORMALIZATION DETAILS:                                                     │
│  ──────────────────────                                                     │
│  _normalize_for_hard_match() strips ALL punctuation/whitespace:             │
│                                                                             │
│    "Tense / 'highly strung'"  →  "tensehighlystrung"                        │
│    "tense/'highly strung',"   →  "tensehighlystrung"                        │
│    "tense/\textbackslash\textbraceleft{\textbraceright{}\textbraceright{}\textbackslash\textbraceleft{\textbraceright{}\textbraceright{}"highly strung\textbackslash\textbraceleft{\textbraceright{}\textbraceright{}\textbackslash\textbraceleft{\textbraceright{}\textbraceright{}""  →  "tensehighlystrung"                        │
│                                                                             │
│  This handles OCR artifacts and typographic variation.                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    EXAMPLE 3: TITLE ACRONYM MATCH                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  INPUT:                                                                     │
│  ─────                                                                      │
│  Paper text: "LVEDV was measured using cardiac MRI"                         │
│  Target field: 22420                                                        │
│  Title: "Left ventricular end diastolic volume (LVEDV)"                     │
│                                                                             │
│  MATCHING FLOW:                                                             │
│  ──────────────                                                             │
│                                                                             │
│    span_text: "LVEDV"                                                       │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │ Step 1: Field ID patterns?      │                                      │
│    │         NO                      │                                      │
│    └─────────────────────────────────┘                                      │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │ Step 2: Title exact match?      │                                      │
│    │         NO ("LVEDV" ≠ full      │                                      │
│    │            title)               │                                      │
│    └─────────────────────────────────┘                                      │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │ Step 3: Title acronym check     │                                      │
│    │                                 │                                      │
│    │ _extract_title_acronyms()       │                                      │
│    │ finds "(LVEDV)" in title        │                                      │
│    │                                 │                                      │
│    │ Config guards:                  │                                      │
│    │ • title_acronym_min_length: 4   │                                      │
│    │ • title_acronym_max_length: 15  │                                      │
│    │ • require_parentheses: true     │                                      │
│    │                                 │                                      │
│    │ "LVEDV" = 5 chars (4-15) ✓      │                                      │
│    │ In parentheses in title ✓       │                                      │
│    │ Span matches acronym ✓          │                                      │
│    └─────────────────────────────────┘                                      │
│          │                                                                  │
│          ▼                                                                  │
│    ┌─────────────────────────────────┐                                      │
│    │      is_hard_match = TRUE       │                                      │
│    │  (is_title_acronym_match=TRUE)  │                                      │
│    └─────────────────────────────────┘                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

\end{Verbatim}
~~~




---


## 4. Provenance Architecture: Why Word Tokens Matter




~~~{=html}
<pre class="notion-ascii-diagram"><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                    PROVENANCE: FROM PDF TO HIGHLIGHT                        │
└─────────────────────────────────────────────────────────────────────────────┘

     PDF Page                 Stage 0 (Indexing)           Stage 2 (Matching)
    ──────────                ─────────────────           ──────────────────

 ┌────────────────┐      ┌──────────────────────┐    ┌──────────────────────┐
 │ We used ukb    │      │ ES Document:         │    │ After HARD MATCH:    │
 │ field 4080     │      │                      │    │                      │
 │ for blood      │  ─►  │ text: &quot;We used ukb   │ ─► │ span_text: &quot;ukb      │
 │ pressure...    │      │       field 4080...&quot; │    │            field     │
 │                │      │                      │    │            4080&quot;     │
 └────────────────┘      │ word_texts:          │    │                      │
                         │ [&quot;We&quot;,&quot;used&quot;,&quot;ukb&quot;,  │    │ span_char_start: 8   │
    ┌─────┐              │  &quot;field&quot;,&quot;4080&quot;,...] │    │ span_char_end: 22    │
    │ OCR │              │                      │    │                      │
    │ ▼   │              │ word_token_ids:      │    │ matched_alias_       │
 ┌──┴─────┴──┐           │ [0, 1, 2, 3, 4, ...] │    │ word_token_ids:      │
 │ Bounding  │           │                      │    │ [2, 3, 4]            │
 │ Boxes per │           │ word_bboxes_json:    │    │                      │
 │ word      │           │ [[x,y,w,h],...]      │    │ matched_alias_       │
 └───────────┘           │                      │    │ word_bboxes:         │
                         │ word_char_starts:    │    │ [[234,100,280,120],  │
                         │ [0, 3, 8, 12, 18]    │    │  [282,100,320,120],  │
                         │                      │    │  [322,100,360,120]]  │
                         │ word_char_ends:      │    │                      │
                         │ [2, 7, 11, 17, 22]   │    │ span_text_method:    │
                         │                      │    │ &quot;char_offsets&quot;       │
                         └──────────────────────┘    └──────────────────────┘
                                                              │
                                                              ▼
                                                     ┌──────────────────────┐
                                                     │ HITL REVIEWER CAN:   │
                                                     │                      │
                                                     │ 1. See exact page    │
                                                     │    coordinates       │
                                                     │                      │
                                                     │ 2. Draw highlight    │
                                                     │    box on PDF        │
                                                     │                      │
                                                     │ 3. Verify match      │
                                                     │    visually          │
                                                     │                      │
                                                     │ REPRODUCIBLE &amp;       │
                                                     │ AUDITABLE            │
                                                     └──────────────────────┘
</code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PROVENANCE: FROM PDF TO HIGHLIGHT                        │
└─────────────────────────────────────────────────────────────────────────────┘

     PDF Page                 Stage 0 (Indexing)           Stage 2 (Matching)
    ──────────                ─────────────────           ──────────────────

 ┌────────────────┐      ┌──────────────────────┐    ┌──────────────────────┐
 │ We used ukb    │      │ ES Document:         │    │ After HARD MATCH:    │
 │ field 4080     │      │                      │    │                      │
 │ for blood      │  ─►  │ text: "We used ukb   │ ─► │ span_text: "ukb      │
 │ pressure...    │      │       field 4080..." │    │            field     │
 │                │      │                      │    │            4080"     │
 └────────────────┘      │ word_texts:          │    │                      │
                         │ ["We","used","ukb",  │    │ span_char_start: 8   │
    ┌─────┐              │  "field","4080",...] │    │ span_char_end: 22    │
    │ OCR │              │                      │    │                      │
    │ ▼   │              │ word_token_ids:      │    │ matched_alias_       │
 ┌──┴─────┴──┐           │ [0, 1, 2, 3, 4, ...] │    │ word_token_ids:      │
 │ Bounding  │           │                      │    │ [2, 3, 4]            │
 │ Boxes per │           │ word_bboxes_json:    │    │                      │
 │ word      │           │ [[x,y,w,h],...]      │    │ matched_alias_       │
 └───────────┘           │                      │    │ word_bboxes:         │
                         │ word_char_starts:    │    │ [[234,100,280,120],  │
                         │ [0, 3, 8, 12, 18]    │    │  [282,100,320,120],  │
                         │                      │    │  [322,100,360,120]]  │
                         │ word_char_ends:      │    │                      │
                         │ [2, 7, 11, 17, 22]   │    │ span_text_method:    │
                         │                      │    │ "char_offsets"       │
                         └──────────────────────┘    └──────────────────────┘
                                                              │
                                                              ▼
                                                     ┌──────────────────────┐
                                                     │ HITL REVIEWER CAN:   │
                                                     │                      │
                                                     │ 1. See exact page    │
                                                     │    coordinates       │
                                                     │                      │
                                                     │ 2. Draw highlight    │
                                                     │    box on PDF        │
                                                     │                      │
                                                     │ 3. Verify match      │
                                                     │    visually          │
                                                     │                      │
                                                     │ REPRODUCIBLE &       │
                                                     │ AUDITABLE            │
                                                     └──────────────────────┘

\end{Verbatim}
~~~




### The span_text Fields Explained



<table>
  <thead>
    <tr>
      <th>Field</th>
      <th>Purpose</th>
      <th>Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>span_text</code></td>
      <td>Raw substring from paper (unmodified)</td>
      <td><code>&quot;Current tobacco smoking&quot;</code></td>
    </tr>
    <tr>
      <td><code>span_char_start</code></td>
      <td>Start position in line text</td>
      <td><code>8</code></td>
    </tr>
    <tr>
      <td><code>span_char_end</code></td>
      <td>End position in line text</td>
      <td><code>31</code></td>
    </tr>
    <tr>
      <td><code>span_line_indices</code></td>
      <td>Which lines (for multi-line spans)</td>
      <td><code>[0]</code> or <code>[0,1]</code></td>
    </tr>
    <tr>
      <td><code>span_line_char_ranges</code></td>
      <td>Per-line character ranges</td>
      <td><code>[{&quot;line_index&quot;: 0, &quot;char_start&quot;: 8, &quot;char_end&quot;: 31}]</code></td>
    </tr>
    <tr>
      <td><code>span_text_method</code></td>
      <td>How span was computed</td>
      <td><code>&quot;char_offsets&quot;</code> (precise) or <code>&quot;token_join&quot;</code> (fallback)</td>
    </tr>
  </tbody>
</table>



---


## 5. Pros and Cons: An Honest Assessment




~~~{=html}
<pre class="notion-ascii-diagram"><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                             PROS                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. THEORETICAL SOUNDNESS                                                   │
│     ───────────────────────                                                 │
│     Field IDs are IDENTIFIERS, not semantic content.                        │
│     &quot;ukb field 4080&quot; has ONE meaning - embedding scores add noise.          │
│                                                                             │
│  2. COMPUTATIONAL EFFICIENCY                                                │
│     ────────────────────────                                                │
│     Skip embedding inference for deterministic matches.                     │
│     ~20-40% of matches are hard matches → significant GPU savings.          │
│                                                                             │
│  3. PERFECT PRECISION FOR KNOWN PATTERNS                                    │
│     ──────────────────────────────────────                                  │
│     Field ID patterns: 0% false positives (by design).                      │
│     Title matches: 0% false positives if exact after normalization.         │
│                                                                             │
│  4. REPRODUCIBILITY                                                         │
│     ───────────────                                                         │
│     Deterministic rules = same input → same output.                         │
│     No model randomness or version drift.                                   │
│                                                                             │
│  5. AUDITABILITY                                                            │
│     ─────────────                                                           │
│     is_hard_match=True flag allows post-hoc review.                         │
│     Provenance (word_token_ids, bboxes) enables visual verification.        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                             CONS / LIMITATIONS                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. PATTERN COVERAGE IS FINITE                                              │
│     ────────────────────────────                                            │
│     We have 40+ field ID templates, but authors may use novel formats:      │
│     • &quot;biobank variable #4080&quot; (if not in templates → soft match)           │
│     • Typos: &quot;ukb filed 4080&quot; → NOT caught as hard match                    │
│                                                                             │
│     MITIGATION: Template list is extensible. We can add patterns based      │
│     on false negative analysis.                                             │
│                                                                             │
│  2. TITLE NORMALIZATION ASSUMPTIONS                                         │
│     ─────────────────────────────────                                       │
│     We strip ALL punctuation for comparison:                                │
│     &quot;Tense / &#39;highly strung&#39;&quot; → &quot;tensehighlystrung&quot;                         │
│                                                                             │
│     RISK: Could equate semantically different phrases that normalize same.  │
│     EXAMPLE: Hypothetically, &quot;C-reactive&quot; vs &quot;C reactive&quot; (same after norm) │
│                                                                             │
│     MITIGATION: Title guard requires min tokens (2) or min chars (8),       │
│     making accidental collisions extremely unlikely.                        │
│                                                                             │
│  3. NO CONTEXTUAL DISAMBIGUATION                                            │
│     ───────────────────────────────                                         │
│     Hard matches ignore surrounding context:                                │
│     &quot;ukb field 4080 was NOT used in this study&quot; → still marked hard match   │
│                                                                             │
│     MITIGATION: This is a recall-oriented design. Downstream stages can     │
│     filter negated mentions. The match itself is still correct.             │
│                                                                             │
│  4. ACRONYM AMBIGUITY                                                       │
│     ──────────────────                                                      │
│     Some acronyms are shared across fields:                                 │
│     &quot;BMI&quot; could be multiple fields with same acronym.                       │
│                                                                             │
│     MITIGATION:                                                             │
│     • title_acronym_min_length: 4 (excludes 2-3 char ambiguous ones)        │
│     • require_parentheses: true (must be explicitly defined in title)       │
│     • For derived acronyms: require token overlap (e.g., &quot;circumference&quot;)   │
│                                                                             │
│  5. RISKY PATTERNS GATED BY LENGTH                                          │
│     ──────────────────────────────                                          │
│     &quot;(95)&quot; or &quot;[95]&quot; are risky for short field IDs (collision with refs).   │
│     We only use risky_templates when field_id length ≥ 5 digits.            │
│                                                                             │
│     LIMITATION: Short field IDs (1-4 digits) miss some valid references.    │
│     MITIGATION: Window propagation recovers these via trusted anchors.      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
</code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
┌─────────────────────────────────────────────────────────────────────────────┐
│                             PROS                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. THEORETICAL SOUNDNESS                                                   │
│     ───────────────────────                                                 │
│     Field IDs are IDENTIFIERS, not semantic content.                        │
│     "ukb field 4080" has ONE meaning - embedding scores add noise.          │
│                                                                             │
│  2. COMPUTATIONAL EFFICIENCY                                                │
│     ────────────────────────                                                │
│     Skip embedding inference for deterministic matches.                     │
│     ~20-40% of matches are hard matches → significant GPU savings.          │
│                                                                             │
│  3. PERFECT PRECISION FOR KNOWN PATTERNS                                    │
│     ──────────────────────────────────────                                  │
│     Field ID patterns: 0% false positives (by design).                      │
│     Title matches: 0% false positives if exact after normalization.         │
│                                                                             │
│  4. REPRODUCIBILITY                                                         │
│     ───────────────                                                         │
│     Deterministic rules = same input → same output.                         │
│     No model randomness or version drift.                                   │
│                                                                             │
│  5. AUDITABILITY                                                            │
│     ─────────────                                                           │
│     is_hard_match=True flag allows post-hoc review.                         │
│     Provenance (word_token_ids, bboxes) enables visual verification.        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                             CONS / LIMITATIONS                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. PATTERN COVERAGE IS FINITE                                              │
│     ────────────────────────────                                            │
│     We have 40+ field ID templates, but authors may use novel formats:      │
│     • "biobank variable #4080" (if not in templates → soft match)           │
│     • Typos: "ukb filed 4080" → NOT caught as hard match                    │
│                                                                             │
│     MITIGATION: Template list is extensible. We can add patterns based      │
│     on false negative analysis.                                             │
│                                                                             │
│  2. TITLE NORMALIZATION ASSUMPTIONS                                         │
│     ─────────────────────────────────                                       │
│     We strip ALL punctuation for comparison:                                │
│     "Tense / 'highly strung'" → "tensehighlystrung"                         │
│                                                                             │
│     RISK: Could equate semantically different phrases that normalize same.  │
│     EXAMPLE: Hypothetically, "C-reactive" vs "C reactive" (same after norm) │
│                                                                             │
│     MITIGATION: Title guard requires min tokens (2) or min chars (8),       │
│     making accidental collisions extremely unlikely.                        │
│                                                                             │
│  3. NO CONTEXTUAL DISAMBIGUATION                                            │
│     ───────────────────────────────                                         │
│     Hard matches ignore surrounding context:                                │
│     "ukb field 4080 was NOT used in this study" → still marked hard match   │
│                                                                             │
│     MITIGATION: This is a recall-oriented design. Downstream stages can     │
│     filter negated mentions. The match itself is still correct.             │
│                                                                             │
│  4. ACRONYM AMBIGUITY                                                       │
│     ──────────────────                                                      │
│     Some acronyms are shared across fields:                                 │
│     "BMI" could be multiple fields with same acronym.                       │
│                                                                             │
│     MITIGATION:                                                             │
│     • title_acronym_min_length: 4 (excludes 2-3 char ambiguous ones)        │
│     • require_parentheses: true (must be explicitly defined in title)       │
│     • For derived acronyms: require token overlap (e.g., "circumference")   │
│                                                                             │
│  5. RISKY PATTERNS GATED BY LENGTH                                          │
│     ──────────────────────────────                                          │
│     "(95)" or "[95]" are risky for short field IDs (collision with refs).   │
│     We only use risky_templates when field_id length ≥ 5 digits.            │
│                                                                             │
│     LIMITATION: Short field IDs (1-4 digits) miss some valid references.    │
│     MITIGATION: Window propagation recovers these via trusted anchors.      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

\end{Verbatim}
~~~




---


## 6. Config Parameters: Your Defense Points


Your stage2.yaml configuration shows deliberate, defensible choices:



### Field ID Patterns (`field_id_patterns`)




~~~yaml
templates:  # 40+ SAFE patterns - unambiguous UK Biobank references
  - "field {id}"           # Standard documentation format
  - "ukb {id}"             # Common abbreviation
  - "data-field {id}"      # Hyphenated variant
  - ...

risky_templates:           # Only applied when field_id ≥ 5 digits
  - "({id})"               # Could be citation number for short IDs
  - "[{id}]"               # Could be reference for short IDs

risky_min_field_id_length: 5   # GUARD: 4-digit IDs don't match risky patterns

~~~




Defense: Safe patterns are domain-specific UK Biobank terminology. Risky patterns are gated to prevent citation/reference collisions.



### Hard Match Guards (`hard_match`)




~~~yaml
min_title_match_length: 8      # Single-token titles must be specific
min_title_match_tokens: 2      # Multi-token: require at least 2 tokens

title_acronym_min_length: 4    # Exclude short ambiguous acronyms (BP, HR)
title_acronym_max_length: 15   # Sanity upper bound
title_acronym_require_parentheses: true  # Must be explicitly defined

title_stopword_affix_stopwords:  # Only allow trivial function words
  - "and", "or", "the", ...

~~~




Defense: Multiple guard layers prevent false positives while maintaining high recall for legitimate matches.



---


## 7. Visual: The Full Pipeline Flow




~~~{=html}
<pre class="notion-ascii-diagram"><code>┌─────────────────────────────────────────────────────────────────────────────┐
│                    STAGE 2: CONTEXT CAPTURE PIPELINE                        │
└─────────────────────────────────────────────────────────────────────────────┘

  feature_alias_map.json                  ES Corpus
  (from Stage 1)                          (from Stage 0)
         │                                      │
         │                                      │
         ▼                                      ▼
  ┌─────────────────┐                ┌─────────────────────┐
  │ Field 4080:     │                │ Indexed documents   │
  │ • aliases:      │                │ with word_token_ids │
  │   - &quot;systolic   │                │ and word_bboxes     │
  │     blood...&quot;   │                │                     │
  │   - &quot;SBP&quot;       │                └──────────┬──────────┘
  │ • title:        │                           │
  │   &quot;Systolic...&quot; │                           │
  └────────┬────────┘                           │
           │                                    │
           └────────────────┬───────────────────┘
                            │
                            ▼
           ┌────────────────────────────────────┐
           │     ES PHRASE SEARCH (text_lower)  │
           │     ──────────────────────────────│
           │  Query: aliases + field_id patterns │
           │  Returns: contexts with provenance  │
           └────────────────┬───────────────────┘
                            │
                            ▼
           ┌────────────────────────────────────┐
           │      WORD-SEQUENCE MATCHING        │
           │      ──────────────────────        │
           │  Match alias tokens to word_texts  │
           │  Get precise word indices [i:j]    │
           │  Extract word_token_ids[i:j]       │
           │  Extract word_bboxes[i:j]          │
           └────────────────┬───────────────────┘
                            │
                            ▼
           ┌────────────────────────────────────┐
           │       HARD MATCH DETECTION         │
           │       ────────────────────         │
           │                                    │
           │  Is field_id pattern?              │
           │       ↓ YES                        │
           │  is_hard_match = TRUE ────────────►│──┐
           │       ↓ NO                         │  │
           │  Is exact title match?             │  │
           │       ↓ YES                        │  │
           │  is_hard_match = TRUE ────────────►│──┤
           │       ↓ NO                         │  │
           │  Is title acronym?                 │  │
           │       ↓ YES                        │  │
           │  is_hard_match = TRUE ────────────►│──┤
           │       ↓ NO                         │  │
           │  (more checks...)                  │  │
           │       ↓ NO                         │  │
           │  is_hard_match = FALSE             │  │
           └────────────────┬───────────────────┘  │
                            │                      │
              ┌─────────────┴─────────────┐        │
              │                           │        │
              ▼                           │        │
   ┌──────────────────────┐               │        │
   │  SEMANTIC SCORING    │               │        │
   │  ────────────────    │               │        │
   │  Embed snippet       │               │        │
   │  Compare to feature  │               │        │
   │  Apply thresholds    │               │        │
   │  (ensemble if ON)    │               │        │
   └──────────┬───────────┘               │        │
              │                           │        │
              │                           │        │
              └───────────┬───────────────┘        │
                          │◄───────────────────────┘
                          │     (hard matches rejoin here)
                          ▼
           ┌────────────────────────────────────┐
           │      CONFIDENCE CLASSIFICATION     │
           │      ─────────────────────────     │
           │  score ≥ 0.80 → HIGH               │
           │  score ≥ 0.60 → MEDIUM             │
           │  score ≥ 0.35 → LOW                │
           │                                    │
           │  Hard matches: typically HIGH      │
           │  (they still get semantic score    │
           │   for downstream ranking)          │
           └────────────────┬───────────────────┘
                            │
                            ▼
           ┌────────────────────────────────────┐
           │         OUTPUT: feature_card       │
           │         ────────────────────       │
           │                                    │
           │  {                                 │
           │    &quot;field_id&quot;: &quot;4080&quot;,             │
           │    &quot;contexts&quot;: {                   │
           │      &quot;high&quot;: [...],                │
           │      &quot;medium&quot;: [...],              │
           │      &quot;low&quot;: [...]                  │
           │    },                              │
           │    Each context includes:          │
           │    • span_text (raw paper text)    │
           │    • span_char_start/end           │
           │    • matched_alias_word_token_ids  │
           │    • matched_alias_word_bboxes     │
           │    • is_hard_match (audit flag)    │
           │  }                                 │
           └────────────────────────────────────┘
</code></pre>
~~~

~~~{=latex}
\begin{Verbatim}[commandchars=\\\{\}]
┌─────────────────────────────────────────────────────────────────────────────┐
│                    STAGE 2: CONTEXT CAPTURE PIPELINE                        │
└─────────────────────────────────────────────────────────────────────────────┘

  feature_alias_map.json                  ES Corpus
  (from Stage 1)                          (from Stage 0)
         │                                      │
         │                                      │
         ▼                                      ▼
  ┌─────────────────┐                ┌─────────────────────┐
  │ Field 4080:     │                │ Indexed documents   │
  │ • aliases:      │                │ with word_token_ids │
  │   - "systolic   │                │ and word_bboxes     │
  │     blood..."   │                │                     │
  │   - "SBP"       │                └──────────┬──────────┘
  │ • title:        │                           │
  │   "Systolic..." │                           │
  └────────┬────────┘                           │
           │                                    │
           └────────────────┬───────────────────┘
                            │
                            ▼
           ┌────────────────────────────────────┐
           │     ES PHRASE SEARCH (text_lower)  │
           │     ──────────────────────────────│
           │  Query: aliases + field_id patterns │
           │  Returns: contexts with provenance  │
           └────────────────┬───────────────────┘
                            │
                            ▼
           ┌────────────────────────────────────┐
           │      WORD-SEQUENCE MATCHING        │
           │      ──────────────────────        │
           │  Match alias tokens to word_texts  │
           │  Get precise word indices [i:j]    │
           │  Extract word_token_ids[i:j]       │
           │  Extract word_bboxes[i:j]          │
           └────────────────┬───────────────────┘
                            │
                            ▼
           ┌────────────────────────────────────┐
           │       HARD MATCH DETECTION         │
           │       ────────────────────         │
           │                                    │
           │  Is field_id pattern?              │
           │       ↓ YES                        │
           │  is_hard_match = TRUE ────────────►│──┐
           │       ↓ NO                         │  │
           │  Is exact title match?             │  │
           │       ↓ YES                        │  │
           │  is_hard_match = TRUE ────────────►│──┤
           │       ↓ NO                         │  │
           │  Is title acronym?                 │  │
           │       ↓ YES                        │  │
           │  is_hard_match = TRUE ────────────►│──┤
           │       ↓ NO                         │  │
           │  (more checks...)                  │  │
           │       ↓ NO                         │  │
           │  is_hard_match = FALSE             │  │
           └────────────────┬───────────────────┘  │
                            │                      │
              ┌─────────────┴─────────────┐        │
              │                           │        │
              ▼                           │        │
   ┌──────────────────────┐               │        │
   │  SEMANTIC SCORING    │               │        │
   │  ────────────────    │               │        │
   │  Embed snippet       │               │        │
   │  Compare to feature  │               │        │
   │  Apply thresholds    │               │        │
   │  (ensemble if ON)    │               │        │
   └──────────┬───────────┘               │        │
              │                           │        │
              │                           │        │
              └───────────┬───────────────┘        │
                          │◄───────────────────────┘
                          │     (hard matches rejoin here)
                          ▼
           ┌────────────────────────────────────┐
           │      CONFIDENCE CLASSIFICATION     │
           │      ─────────────────────────     │
           │  score ≥ 0.80 → HIGH               │
           │  score ≥ 0.60 → MEDIUM             │
           │  score ≥ 0.35 → LOW                │
           │                                    │
           │  Hard matches: typically HIGH      │
           │  (they still get semantic score    │
           │   for downstream ranking)          │
           └────────────────┬───────────────────┘
                            │
                            ▼
           ┌────────────────────────────────────┐
           │         OUTPUT: feature_card       │
           │         ────────────────────       │
           │                                    │
           │  \textbraceleft{\textbraceright{}                                 │
           │    "field_id": "4080",             │
           │    "contexts": \textbraceleft{\textbraceright{}                   │
           │      "high": [...],                │
           │      "medium": [...],              │
           │      "low": [...]                  │
           │    \textbraceright{},                              │
           │    Each context includes:          │
           │    • span_text (raw paper text)    │
           │    • span_char_start/end           │
           │    • matched_alias_word_token_ids  │
           │    • matched_alias_word_bboxes     │
           │    • is_hard_match (audit flag)    │
           │  \textbraceright{}                                 │
           └────────────────────────────────────┘

\end{Verbatim}
~~~




---


## 8. Key Takeaways for Your Viva


### For Life Science Lecturers:

> "When a paper says 'ukb field 4080', we know with 100% certainty they're referencing field 4080. Running this through a neural network would add computational cost without adding information. We call these hard matches and accept them directly, while still recording the exact text location for audit."

### For Data Science Lecturers:

> "Hard matching implements a Bayesian prior of 1.0 for deterministic identifiers. The posterior cannot exceed the prior, so embedding scores are redundant. We formalize this with 40+ template patterns for field IDs and guarded title matching with minimum token/character requirements to prevent false positives. All matches retain full provenance (word_token_ids, bounding boxes) for reproducibility and HITL verification."

### The Honest Limitation:

> "Our pattern list is finite and manually curated. Novel reference formats not in our templates will fall through to semantic matching, which may have lower recall. However, the template list is extensible, and the is_hard_match flag enables post-hoc analysis to identify missed patterns for future versions."
