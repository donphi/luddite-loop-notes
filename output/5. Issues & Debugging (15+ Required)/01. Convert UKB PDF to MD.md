# Convert UKB PDF to MD


## Content


# PDF to Markdown Pipeline


## Initial Problem

- Using **Docling + Marker** together → overcomplicated, slow.
- Decided to pick one tool after anecdotal testing.
- Key difference:
    - **Docling**: struggled with accurate equation capture.
    - **Marker**: more reliable overall.

Image Comparison:






- **PDF**:

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/7a8a68e8-5855-41f2-ae17-565ecdbd6218/2f1da4b6-8f6c-4b14-88ae-669bcc140c1d/Screenshot_2025-08-09_at_1.02.39_PM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466Q7J4NGME%2F20260112%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20260112T014530Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEBgaCXVzLXdlc3QtMiJIMEYCIQDOyUlyN7T38OhIp1IMBf26JBwKHZlRE%2BQyC5f9rCdcOAIhAOVSPum%2FTpfaCLljtCIqkvqzKcucbRtXYygJ3ZksWEgoKogECOH%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1IgwKTSNkkqM2om2CHUIq3AMMCt6oPK7G%2BSpAwlurtoy5AYeiJ0ou94l6gstohsBiil93qPOz2TNxNg6k9gtmfGiXQa2pZCTQEzm5Uqgzu6BPG1JOzUILwH3X0cBFau3CakukjywOek%2F4CUuGiRru8zAOZbr6RTHsHPRzpgYUO6V1Tu3L4vVS04N2em%2FMTvC0EC6hnULxQW6FlhRj3VhNtq%2Bf9HuahdyJnDk4gEGlfd7stPxL7%2BkrgD8Bg4BNlZpz%2FCHzWNlqdzd41f8%2BZeWFdWjKp1YUxVzReGwjHjBYjpEaW4EgMIZx4z0HlYoLVTzcd010DSBiPds6CL%2FDtXL8pxvhs%2Fodd1g%2BIyEZr7lfddZdnBR6EVcHRFnQ%2FG3nsVJak7%2FjA4D%2BodwmAEGSq%2BI945EToleuX64btczjBAlu2RXIMLQOM85G9Ssjw7i%2FHSWUJ1zu6OuYHbvc3G9hnnDt9j5SDt%2FZ%2FWmSW%2BuyLEHlsWkGSkfKCpkLfratKmg1lCLcK6Ni%2BgHRTeM8%2FscsUCBJ00swAP%2F2g58zWzpLGi669%2BIJsP5pdrJkErbHGywnPpqY4EcS4kjugvOpulQaNzNYQOLaNxV9dd0mlspEBYuPwGP6GwADtN1%2B3Kluz%2FTRPYif%2Fjstbi2iiE%2FnZt0GMzCG5ZDLBjqkAXxdnBXtIWRka9jdMcnLMLziasiK9%2B6oZiw05Hm37pWGioPU53ARXf0XA8omjJHwsMewVFZnHBn%2BcKRqToqOAX3uXtk1LoLJ%2BL8Vdtbw%2BTPxq0DieQol5t8oNgiHb4NC20AsOrv5aYQ8%2F6t8bb8B5KjHUj5SS4FaKaACZXLyf2yBVHLv4uwV2SjmTrZZwQE2T943mveBiO%2FqRfrsbcR1Iw4KXPxZ&X-Amz-Signature=46dad1a301798a273b4be33ebeb6b62b0146815b8615235c63d9f37f9c3ed44b&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)





- **MD**:

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/7a8a68e8-5855-41f2-ae17-565ecdbd6218/c6039918-0530-436c-9729-71d14ede362d/Screenshot_2025-08-09_at_1.00.05_PM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466Q7J4NGME%2F20260112%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20260112T014530Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEBgaCXVzLXdlc3QtMiJIMEYCIQDOyUlyN7T38OhIp1IMBf26JBwKHZlRE%2BQyC5f9rCdcOAIhAOVSPum%2FTpfaCLljtCIqkvqzKcucbRtXYygJ3ZksWEgoKogECOH%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1IgwKTSNkkqM2om2CHUIq3AMMCt6oPK7G%2BSpAwlurtoy5AYeiJ0ou94l6gstohsBiil93qPOz2TNxNg6k9gtmfGiXQa2pZCTQEzm5Uqgzu6BPG1JOzUILwH3X0cBFau3CakukjywOek%2F4CUuGiRru8zAOZbr6RTHsHPRzpgYUO6V1Tu3L4vVS04N2em%2FMTvC0EC6hnULxQW6FlhRj3VhNtq%2Bf9HuahdyJnDk4gEGlfd7stPxL7%2BkrgD8Bg4BNlZpz%2FCHzWNlqdzd41f8%2BZeWFdWjKp1YUxVzReGwjHjBYjpEaW4EgMIZx4z0HlYoLVTzcd010DSBiPds6CL%2FDtXL8pxvhs%2Fodd1g%2BIyEZr7lfddZdnBR6EVcHRFnQ%2FG3nsVJak7%2FjA4D%2BodwmAEGSq%2BI945EToleuX64btczjBAlu2RXIMLQOM85G9Ssjw7i%2FHSWUJ1zu6OuYHbvc3G9hnnDt9j5SDt%2FZ%2FWmSW%2BuyLEHlsWkGSkfKCpkLfratKmg1lCLcK6Ni%2BgHRTeM8%2FscsUCBJ00swAP%2F2g58zWzpLGi669%2BIJsP5pdrJkErbHGywnPpqY4EcS4kjugvOpulQaNzNYQOLaNxV9dd0mlspEBYuPwGP6GwADtN1%2B3Kluz%2FTRPYif%2Fjstbi2iiE%2FnZt0GMzCG5ZDLBjqkAXxdnBXtIWRka9jdMcnLMLziasiK9%2B6oZiw05Hm37pWGioPU53ARXf0XA8omjJHwsMewVFZnHBn%2BcKRqToqOAX3uXtk1LoLJ%2BL8Vdtbw%2BTPxq0DieQol5t8oNgiHb4NC20AsOrv5aYQ8%2F6t8bb8B5KjHUj5SS4FaKaACZXLyf2yBVHLv4uwV2SjmTrZZwQE2T943mveBiO%2FqRfrsbcR1Iw4KXPxZ&X-Amz-Signature=8b8b3fc0537a989858de9072ff1edf25ab207fd4b68f43569fff3b7e255e5b97&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)





- **Preview**:

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/7a8a68e8-5855-41f2-ae17-565ecdbd6218/d8cf6e17-63f7-4ebd-885b-f9a7cc04099b/Screenshot_2025-08-09_at_12.57.09_PM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466Q7J4NGME%2F20260112%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20260112T014530Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEBgaCXVzLXdlc3QtMiJIMEYCIQDOyUlyN7T38OhIp1IMBf26JBwKHZlRE%2BQyC5f9rCdcOAIhAOVSPum%2FTpfaCLljtCIqkvqzKcucbRtXYygJ3ZksWEgoKogECOH%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEQABoMNjM3NDIzMTgzODA1IgwKTSNkkqM2om2CHUIq3AMMCt6oPK7G%2BSpAwlurtoy5AYeiJ0ou94l6gstohsBiil93qPOz2TNxNg6k9gtmfGiXQa2pZCTQEzm5Uqgzu6BPG1JOzUILwH3X0cBFau3CakukjywOek%2F4CUuGiRru8zAOZbr6RTHsHPRzpgYUO6V1Tu3L4vVS04N2em%2FMTvC0EC6hnULxQW6FlhRj3VhNtq%2Bf9HuahdyJnDk4gEGlfd7stPxL7%2BkrgD8Bg4BNlZpz%2FCHzWNlqdzd41f8%2BZeWFdWjKp1YUxVzReGwjHjBYjpEaW4EgMIZx4z0HlYoLVTzcd010DSBiPds6CL%2FDtXL8pxvhs%2Fodd1g%2BIyEZr7lfddZdnBR6EVcHRFnQ%2FG3nsVJak7%2FjA4D%2BodwmAEGSq%2BI945EToleuX64btczjBAlu2RXIMLQOM85G9Ssjw7i%2FHSWUJ1zu6OuYHbvc3G9hnnDt9j5SDt%2FZ%2FWmSW%2BuyLEHlsWkGSkfKCpkLfratKmg1lCLcK6Ni%2BgHRTeM8%2FscsUCBJ00swAP%2F2g58zWzpLGi669%2BIJsP5pdrJkErbHGywnPpqY4EcS4kjugvOpulQaNzNYQOLaNxV9dd0mlspEBYuPwGP6GwADtN1%2B3Kluz%2FTRPYif%2Fjstbi2iiE%2FnZt0GMzCG5ZDLBjqkAXxdnBXtIWRka9jdMcnLMLziasiK9%2B6oZiw05Hm37pWGioPU53ARXf0XA8omjJHwsMewVFZnHBn%2BcKRqToqOAX3uXtk1LoLJ%2BL8Vdtbw%2BTPxq0DieQol5t8oNgiHb4NC20AsOrv5aYQ8%2F6t8bb8B5KjHUj5SS4FaKaACZXLyf2yBVHLv4uwV2SjmTrZZwQE2T943mveBiO%2FqRfrsbcR1Iw4KXPxZ&X-Amz-Signature=0e22cffa81667d2bfa8d4387cc79b4f75714f348afb7520f500d1e4cefdcee79&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)






Observation:



Docling failed to capture equations cleanly and consistently (see PDF vs MD vs Preview placeholders above).



---


## OCR vs Hybrid Test

- **Sample size**: 20 PDFs (out of ~7,000; proper statistical sample = 168).
- **Word Extraction**:
    - Hybrid: 161,419 words
    - Forced OCR: 161,242 words
    - Δ = -177 words (-0.1%)
- **Processing Time**:
    - Hybrid: 476.8s
    - Forced OCR: 843.5s
    - Δ = +366.7s (+76.9%)
- **Table Detection**:
    - Hybrid: 537
    - Forced OCR: 538

Conclusion:



Similar extraction (<5% diff). Hybrid is faster and simpler.



<image placeholder - OCR vs Hybrid results chart>



---


## Metadata Quality Issue

- Marker JSON output must be **clean** (title, DOI, authors).
- Example problem: incorrect DOI/title impacts downstream embeddings + knowledge trees.

Example Output:





~~~javascript
{
"original_file": "(2)2021_park_aa452_dup1.pdf",
"conversion_date": "2025-08-08T21:45:58.754233",
"converter": "marker",
"metadata": {
"title": "and from the same link in the online table of contents at](https://academic.oup.com/jn/) https: //academic.oup.com/jn",
"authors": "Abbreviations used: BP, blood pressure; CKD, chronic kidney disease; eGFR, estimated glomerular filtration rate; GWAS, genome-wide association study; MR, Mendelian randomization; PGS, polygenic score; SNP, single-nucleotide polymorphism.",
"doi": "10.1093/jn/nxaa452.",
"keywords": "estimated glomerular filtration rate, Mendelian randomization, chronic kidney disease, diet, vegetable"
},
"content": {
"markdown": "TEXT",
"text_length": 57905
}
}
~~~








---


## Results Before Improvements (20 PDFs)




~~~javascript
MetricBeforeAfterImprovementAuthor Extraction22.2%100%+351%Complete Metadata¹16.7%94.7%+467%Processing Speed26.0 sec/PDF20.2 sec/PDF22% fasterDOI Extraction72.2%94.7%+31%
~~~




HYBRID_DEFAULT:


- Success: 18/20
- Metadata complete: 16.7%
- Authors extracted: 22.2%
- Titles: 100%
- DOIs: 72.2%

FORCE_OCR:


- Metadata complete: 5.6%
- Authors extracted: 16.7%

---


## Results After Improvements (20 PDFs)


<image placeholder - Metadata results AFTER>



HYBRID_DEFAULT:


- Success: 19/20
- Metadata complete: 94.7%
- Authors extracted: 100%
- Titles: 100%
- DOIs: 94.7%

FORCE_OCR:


- Same metadata rates as Hybrid after improvements.

---


## Metadata Extraction Improvement - Approach


<image placeholder - Cascade approach diagram>


- **Cascade strategy (5 steps)**:
    1. Basic regex patterns
    2. Search near found title
    3. Header scan
    4. Citation format parsing
    5. Last resort: direct PDF object extraction (PyMuPDF)
- **Enhancements**:
    - Expanded search windows (15K → 25K chars)
    - Multiple regex sets: 8 (titles), 15 (authors), 6 (DOIs)
    - Proximity search within 2,000 chars of title
    - DOI search across full doc
    - SequenceMatcher for fuzzy title match
    - Jaccard index for author sets
    - Normalized separators; cleaned superscripts/affiliations/emails

---


## Impact at Scale (n=6,841 UKB Papers)


<image placeholder - Before vs After coverage chart>


- **Before**: ~1,143 papers complete metadata
- **After**: ~6,479 papers complete metadata
- **Gain**: +5,336 searchable papers (↑78% coverage)
- Faster due to fail-fast logic (skip extra steps if early match found)

---


## Limitation

- Sample size (n=50 in later test) not enough for p<0.05 certainty (need n≥168).
- However, improvement magnitude (22% → 100%) suggests strong real-world performance.








