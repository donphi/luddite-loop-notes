## Issues & Debugging (15+ Required) — Issue 1: Convert UKB PDF to MD

**Description:**  
# PDF to Markdown Pipeline Notes

## Initial Problem
- Using Docling + Marker together → overcomplicated, slow.
- Decided to pick one tool after anecdotal testing.
- Key difference:
- Docling: struggled with accurate equation capture.
- Marker: more reliable overall.

---

## OCR vs Hybrid Test
- Sample size: 20 PDFs (out of ~7,000; proper statistical sample = 168).
- Word Extraction:
- Hybrid: 161,419 words
- Forced OCR: 161,242 words
- Δ = -177 words (-0.1%)
- Processing Time:
- Hybrid: 476.8s
- Forced OCR: 843.5s
- Δ = +366.7s (+76.9%)
- Table Detection:
- Hybrid: 537
- Forced OCR: 538
- Conclusion: Similar extraction (<5% diff), Hybrid is faster → use Hybrid.

---

## Metadata Quality Issue
- Marker JSON output must be clean (title, DOI, authors).
- Example: incorrect DOI/title impacts downstream embeddings + knowledge trees.

---

## Results Before Improvements (20 PDFs)
HYBRID_DEFAULT:
- Success: 18/20
- Metadata complete: 16.7%
- Authors extracted: 22.2%
- Titles: 100%
- DOIs: 72.2%

FORCE_OCR:
- Metadata complete: 5.6%
- Authors extracted: 16.7%

---

## Results After Improvements (20 PDFs)
HYBRID_DEFAULT:
- Success: 19/20
- Metadata complete: 94.7%
- Authors extracted: 100%
- Titles: 100%
- DOIs: 94.7%

FORCE_OCR:
- Same metadata rates as Hybrid after improvements.

---

## Metadata Extraction Improvement - Approach
- Cascade strategy (5 steps):
1. Basic regex patterns
2. Search near found title
3. Header scan
4. Citation format parsing
5. Last resort: direct PDF object extraction (PyMuPDF)

- Enhancements:
- Expanded search windows (15K → 25K chars).
- Multiple regex sets: 8 (titles), 15 (authors), 6 (DOIs).
- Proximity search within 2,000 chars of title.
- DOI search across full doc.
- SequenceMatcher for fuzzy title match.
- Jaccard index for author sets.
- Normalized separators; cleaned superscripts/affiliations/emails.

---

## Impact at Scale (n=6,841 UKB Papers)
- Before: ~1,143 papers complete metadata.
- After: ~6,479 papers complete metadata.
- Gain: +5,336 searchable papers (↑78% coverage).
- Faster due to fail-fast logic (skip extra steps if early match found).

---

## Limitation
- Sample size (n=50 in later test) not enough for p<0.05 certainty (need n≥168).
- However, improvement magnitude (22% → 100%) suggests strong real-world performance.
  

**summary:** The initial problem involved using Docling and Marker together, which proved to be overly complicated and slow, particularly due to Docling's struggles with accurate equation capture. The solution was to adopt a hybrid approach that improved metadata extraction efficiency significantly, increasing the number of searchable papers from approximately 1,143 to 6,479, thereby enhancing coverage by 78%.  
**Resolved:** ✓  
**Date:** 2025-08-08  
**Hours:** 3  
**Category:** Data Processing  
**Solution:** ## Metadata Extraction Improvement - Approach

- Cascade strategy (5 steps):
1. Basic regex patterns
2. Search near found title
3. Header scan
4. Citation format parsing
5. Last resort: direct PDF object extraction (PyMuPDF)
- Enhancements:
- Expanded search windows (15K → 25K chars)
- Multiple regex sets: 8 (titles), 15 (authors), 6 (DOIs)
- Proximity search within 2,000 chars of title
- DOI search across full doc
- SequenceMatcher for fuzzy title match
- Jaccard index for author sets
- Normalized separators; cleaned superscripts/affiliations/emails  
**Issue:** Convert UKB PDF to MD  

## Content


# PDF to Markdown Pipeline


## Initial Problem

- Using **Docling + Marker** together → overcomplicated, slow.
- Decided to pick one tool after anecdotal testing.
- Key difference:
    - **Docling**: struggled with accurate equation capture.
    - **Marker**: more reliable overall.

Image Comparison:






- **PDF**:

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/7a8a68e8-5855-41f2-ae17-565ecdbd6218/2f1da4b6-8f6c-4b14-88ae-669bcc140c1d/Screenshot_2025-08-09_at_1.02.39_PM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB4667CEGWXGZ%2F20250818%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250818T222438Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEGYaCXVzLXdlc3QtMiJHMEUCIGtt%2BICvhrgMxosf4GHWYt7cDWiKgjnBM5zKeWYC8779AiEAuMqnG5co098eJHIAIXWwPUqb06hjegFY3ngUQckHuCsqiAQIr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARAAGgw2Mzc0MjMxODM4MDUiDMkwe3HIkciX0aRlaircA45STENaeOnEyq07qFUrJ7eH4jxqnUSfog7AKIqufaTTM%2BmLaonHgKG6evxMc7Q4Gny3Z2WD7D8LW9Duf%2BUB35dzywAcuNO9pNVxXyawiGfAqpmqpGAbKNFfMKl%2BOjPyXWdfjH3yi7xxRoN5Ez9gglpRDZWTB4TKgTdazEBT7%2FAhrK4jKmqJqMv5DF84OrrGYn%2BlPBRZs4iAmE6nBDfOdtYzqqwld%2BgzaFoZqF%2FLjSUU8OQF1RgbWCQlALUnaa3GwZaLdoYvDxHEeNiObtqQzGFN3BwGi9rNlz0s7Kg2lQrr%2FrFj9dq%2BUfOWhn9gwfHjSI16SJ61m2AEnJX8oOBKn8Z%2BKMMeOkpK%2FdjJNcayhie0j7aJfhHu%2FcnF6SDJa%2FCWFBatNo4QIYmaygpruNsPbcGWhgxeOF78i8Ii7MW0QLt5%2FSxpEbpiGL404j46lz6fH36P%2BX6edbyU%2FAtLsDlhjq%2B%2Blza%2BoF2fPofpiT1%2Flvm79cruZbWE5szDlSkUcBpJdylBjsHTztI7tLC8oBebudZ0XjJYTZXjlhPkYQBFE2DHvVNDa6M7%2FW7aNqyJB%2Fr3EubomjkVAd9%2FoBZUFkfo36b3Q6UD6Xr5ZIzcmSO9JjZ6kIWY8LdcqCOCzh0jMM7AjsUGOqUB1Escf8Y%2FPNGGJlyPZjFWqZUhpbm3eND0CBb2bTneAg5hD%2BxsiRN481Sej6LiwCVOhxLoXhJ53COO4DQn9QVBcRypkznu%2B61FT0c%2BkV41MRfUilU8EZEjBURNdD0XjR1YR97l4NZ9ZrvPXP71KkCT3MtlqWsSfLaStidNumt0kQZutXc6YrYoElOkgcy4UP67PxOWZkQGiqpO%2F2cfgb9%2BgZ8eylwJ&X-Amz-Signature=3d5b851b19be4cab6f2f582b43dad14353192131772b7e9d33f70d7674cd4243&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)





- **MD**:

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/7a8a68e8-5855-41f2-ae17-565ecdbd6218/c6039918-0530-436c-9729-71d14ede362d/Screenshot_2025-08-09_at_1.00.05_PM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB4667CEGWXGZ%2F20250818%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250818T222438Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEGYaCXVzLXdlc3QtMiJHMEUCIGtt%2BICvhrgMxosf4GHWYt7cDWiKgjnBM5zKeWYC8779AiEAuMqnG5co098eJHIAIXWwPUqb06hjegFY3ngUQckHuCsqiAQIr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARAAGgw2Mzc0MjMxODM4MDUiDMkwe3HIkciX0aRlaircA45STENaeOnEyq07qFUrJ7eH4jxqnUSfog7AKIqufaTTM%2BmLaonHgKG6evxMc7Q4Gny3Z2WD7D8LW9Duf%2BUB35dzywAcuNO9pNVxXyawiGfAqpmqpGAbKNFfMKl%2BOjPyXWdfjH3yi7xxRoN5Ez9gglpRDZWTB4TKgTdazEBT7%2FAhrK4jKmqJqMv5DF84OrrGYn%2BlPBRZs4iAmE6nBDfOdtYzqqwld%2BgzaFoZqF%2FLjSUU8OQF1RgbWCQlALUnaa3GwZaLdoYvDxHEeNiObtqQzGFN3BwGi9rNlz0s7Kg2lQrr%2FrFj9dq%2BUfOWhn9gwfHjSI16SJ61m2AEnJX8oOBKn8Z%2BKMMeOkpK%2FdjJNcayhie0j7aJfhHu%2FcnF6SDJa%2FCWFBatNo4QIYmaygpruNsPbcGWhgxeOF78i8Ii7MW0QLt5%2FSxpEbpiGL404j46lz6fH36P%2BX6edbyU%2FAtLsDlhjq%2B%2Blza%2BoF2fPofpiT1%2Flvm79cruZbWE5szDlSkUcBpJdylBjsHTztI7tLC8oBebudZ0XjJYTZXjlhPkYQBFE2DHvVNDa6M7%2FW7aNqyJB%2Fr3EubomjkVAd9%2FoBZUFkfo36b3Q6UD6Xr5ZIzcmSO9JjZ6kIWY8LdcqCOCzh0jMM7AjsUGOqUB1Escf8Y%2FPNGGJlyPZjFWqZUhpbm3eND0CBb2bTneAg5hD%2BxsiRN481Sej6LiwCVOhxLoXhJ53COO4DQn9QVBcRypkznu%2B61FT0c%2BkV41MRfUilU8EZEjBURNdD0XjR1YR97l4NZ9ZrvPXP71KkCT3MtlqWsSfLaStidNumt0kQZutXc6YrYoElOkgcy4UP67PxOWZkQGiqpO%2F2cfgb9%2BgZ8eylwJ&X-Amz-Signature=aff872835d6dc274c2adb4c5d24a14ecd5b5de054f4e4ff431dd27d4e0f675a2&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)





- **Preview**:

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/7a8a68e8-5855-41f2-ae17-565ecdbd6218/d8cf6e17-63f7-4ebd-885b-f9a7cc04099b/Screenshot_2025-08-09_at_12.57.09_PM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB4667CEGWXGZ%2F20250818%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20250818T222438Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEGYaCXVzLXdlc3QtMiJHMEUCIGtt%2BICvhrgMxosf4GHWYt7cDWiKgjnBM5zKeWYC8779AiEAuMqnG5co098eJHIAIXWwPUqb06hjegFY3ngUQckHuCsqiAQIr%2F%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARAAGgw2Mzc0MjMxODM4MDUiDMkwe3HIkciX0aRlaircA45STENaeOnEyq07qFUrJ7eH4jxqnUSfog7AKIqufaTTM%2BmLaonHgKG6evxMc7Q4Gny3Z2WD7D8LW9Duf%2BUB35dzywAcuNO9pNVxXyawiGfAqpmqpGAbKNFfMKl%2BOjPyXWdfjH3yi7xxRoN5Ez9gglpRDZWTB4TKgTdazEBT7%2FAhrK4jKmqJqMv5DF84OrrGYn%2BlPBRZs4iAmE6nBDfOdtYzqqwld%2BgzaFoZqF%2FLjSUU8OQF1RgbWCQlALUnaa3GwZaLdoYvDxHEeNiObtqQzGFN3BwGi9rNlz0s7Kg2lQrr%2FrFj9dq%2BUfOWhn9gwfHjSI16SJ61m2AEnJX8oOBKn8Z%2BKMMeOkpK%2FdjJNcayhie0j7aJfhHu%2FcnF6SDJa%2FCWFBatNo4QIYmaygpruNsPbcGWhgxeOF78i8Ii7MW0QLt5%2FSxpEbpiGL404j46lz6fH36P%2BX6edbyU%2FAtLsDlhjq%2B%2Blza%2BoF2fPofpiT1%2Flvm79cruZbWE5szDlSkUcBpJdylBjsHTztI7tLC8oBebudZ0XjJYTZXjlhPkYQBFE2DHvVNDa6M7%2FW7aNqyJB%2Fr3EubomjkVAd9%2FoBZUFkfo36b3Q6UD6Xr5ZIzcmSO9JjZ6kIWY8LdcqCOCzh0jMM7AjsUGOqUB1Escf8Y%2FPNGGJlyPZjFWqZUhpbm3eND0CBb2bTneAg5hD%2BxsiRN481Sej6LiwCVOhxLoXhJ53COO4DQn9QVBcRypkznu%2B61FT0c%2BkV41MRfUilU8EZEjBURNdD0XjR1YR97l4NZ9ZrvPXP71KkCT3MtlqWsSfLaStidNumt0kQZutXc6YrYoElOkgcy4UP67PxOWZkQGiqpO%2F2cfgb9%2BgZ8eylwJ&X-Amz-Signature=bbb039a978fb61401d937de360c7ed40587193b2b2a515c1a511a8d49a5da163&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)






Observation:



Docling failed to capture equations cleanly and consistently (see PDF vs MD vs Preview placeholders above).



---


## OCR vs Hybrid Test

- **Sample size**: 20 PDFs (out of ~7,000; proper statistical sample = 168).
- **Word Extraction**:
    - Hybrid: 161,419 words
    - Forced OCR: 161,242 words
    - Δ = -177 words (-0.1%)
- **Processing Time**:
    - Hybrid: 476.8s
    - Forced OCR: 843.5s
    - Δ = +366.7s (+76.9%)
- **Table Detection**:
    - Hybrid: 537
    - Forced OCR: 538

Conclusion:



Similar extraction (<5% diff). Hybrid is faster and simpler.



<image placeholder - OCR vs Hybrid results chart>



---


## Metadata Quality Issue

- Marker JSON output must be **clean** (title, DOI, authors).
- Example problem: incorrect DOI/title impacts downstream embeddings + knowledge trees.

Example Output:



```javascript
{
"original_file": "(2)2021_park_aa452_dup1.pdf",
"conversion_date": "2025-08-08T21:45:58.754233",
"converter": "marker",
"metadata": {
"title": "and from the same link in the online table of contents at](https://academic.oup.com/jn/) https: //academic.oup.com/jn",
"authors": "Abbreviations used: BP, blood pressure; CKD, chronic kidney disease; eGFR, estimated glomerular filtration rate; GWAS, genome-wide association study; MR, Mendelian randomization; PGS, polygenic score; SNP, single-nucleotide polymorphism.",
"doi": "10.1093/jn/nxaa452.",
"keywords": "estimated glomerular filtration rate, Mendelian randomization, chronic kidney disease, diet, vegetable"
},
"content": {
"markdown": "TEXT",
"text_length": 57905
}
}
```






---


## Results Before Improvements (20 PDFs)


```javascript
MetricBeforeAfterImprovementAuthor Extraction22.2%100%+351%Complete Metadata¹16.7%94.7%+467%Processing Speed26.0 sec/PDF20.2 sec/PDF22% fasterDOI Extraction72.2%94.7%+31%
```


HYBRID_DEFAULT:


- Success: 18/20
- Metadata complete: 16.7%
- Authors extracted: 22.2%
- Titles: 100%
- DOIs: 72.2%

FORCE_OCR:


- Metadata complete: 5.6%
- Authors extracted: 16.7%

---


## Results After Improvements (20 PDFs)


<image placeholder - Metadata results AFTER>



HYBRID_DEFAULT:


- Success: 19/20
- Metadata complete: 94.7%
- Authors extracted: 100%
- Titles: 100%
- DOIs: 94.7%

FORCE_OCR:


- Same metadata rates as Hybrid after improvements.

---


## Metadata Extraction Improvement - Approach


<image placeholder - Cascade approach diagram>


- **Cascade strategy (5 steps)**:
    1. Basic regex patterns
    2. Search near found title
    3. Header scan
    4. Citation format parsing
    5. Last resort: direct PDF object extraction (PyMuPDF)
- **Enhancements**:
    - Expanded search windows (15K → 25K chars)
    - Multiple regex sets: 8 (titles), 15 (authors), 6 (DOIs)
    - Proximity search within 2,000 chars of title
    - DOI search across full doc
    - SequenceMatcher for fuzzy title match
    - Jaccard index for author sets
    - Normalized separators; cleaned superscripts/affiliations/emails

---


## Impact at Scale (n=6,841 UKB Papers)


<image placeholder - Before vs After coverage chart>


- **Before**: ~1,143 papers complete metadata
- **After**: ~6,479 papers complete metadata
- **Gain**: +5,336 searchable papers (↑78% coverage)
- Faster due to fail-fast logic (skip extra steps if early match found)

---


## Limitation

- Sample size (n=50 in later test) not enough for p<0.05 certainty (need n≥168).
- However, improvement magnitude (22% → 100%) suggests strong real-world performance.








