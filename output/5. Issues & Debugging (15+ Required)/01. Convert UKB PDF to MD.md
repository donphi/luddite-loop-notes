# Convert UKB PDF to MD


## Content


# PDF to Markdown Pipeline


## Initial Problem

- Using **Docling + Marker** together → overcomplicated, slow.
- Decided to pick one tool after anecdotal testing.
- Key difference:
    - **Docling**: struggled with accurate equation capture.
    - **Marker**: more reliable overall.

Image Comparison:






- **PDF**:

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/7a8a68e8-5855-41f2-ae17-565ecdbd6218/2f1da4b6-8f6c-4b14-88ae-669bcc140c1d/Screenshot_2025-08-09_at_1.02.39_PM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466SBUHKSOD%2F20251207%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20251207T135310Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEMP%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDfYIlqIYV4KWtIW7oL6UKcjPnXZid3WmlZqhRhpV90mwIgK21yaAJNYjNyS99GOQQkFhHo53QCcSChywSC%2B7Ob9cwqiAQIjP%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARAAGgw2Mzc0MjMxODM4MDUiDH2sOvQxJR1QVQCFyyrcA%2F9MRhVR8H4jFTiBPQGdtTpa%2B0CDLJR3M9bLraE7HjjRKVVOG7CglWfC7E9CQdhbm1q4c6pOm1PaadxBl2VVOyfWEdAeZT8D30UcmQCculkiO2%2Bh5qTBVpH57ZqXN1VT3QE62jJEAarE7EtQnk5MEe%2FMGkWXV7q8VEk4AHR0SC4KrzKsgQccZ3p%2FcDdjNHKpZmfD9hmVjjz9pLV5E5%2FkyLqhjFt%2FCzpzd%2Fb0oM1kQ6s%2BQXrcT6lSRD%2FjcUHDeN6zDEK%2Br3KCjEp3IslKiK1oLhwl4ZNTZZeUXp%2FBTwVkCozbquXo2BJk8Yi7i3bo731uGD996BlC6tjPFH9xci1R0omFEqh2dpfH6%2BKSHtSQoZfSNcqat8dLUtl3jCqEai4D88DjxtZueLCNXgE0NoXGLA8HA6TLjhWWW6f7jMa67z%2FDghQ2WSDwONOPcc6wi3BQWrNM8DDzWj4o3UiT%2BnNs2B35FENISfCUgvQdLts4dgLqeKZRkMlFHhhrwWACwfdlWwzwHwRYzeu7%2F6gA67WFh%2FgUDaPVAnfLvi1aawxxngbTqhCqfhsBwG9%2FYuqB7MpNy2WzuRKpp%2BlmocTXiQ5xemCc4hfCSpOaoz8Dnro%2BfL5hCdC4sBZnXIBB5PCHMNC%2F1ckGOqUBsQ27tN6vddoJMphAa4Ui1lxy81ggxcJ7Nv4gYUSGBU4WYwm%2Fy4F2IwpOZLxUz%2BvUKFVkoQ2ARQouYQBvtyZpwxMoYkep3s2Ofe1NDKtXYM8yJT0A8TN5DxJTRbhDuiqr3EyLgjZ1EtMeO1Ge97mStK5JqB4YnyTbiN8dF4z1Ef%2BkFYQPdFkvKmYW%2Fb5Qcd0T1EfkZ8nzr2XfQY2GQCm8PjyzKToi&X-Amz-Signature=4cda8820586fed13e23114f3f77b2fee517d6cf16f6aada9e639d62de1078104&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)





- **MD**:

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/7a8a68e8-5855-41f2-ae17-565ecdbd6218/c6039918-0530-436c-9729-71d14ede362d/Screenshot_2025-08-09_at_1.00.05_PM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466SBUHKSOD%2F20251207%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20251207T135310Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEMP%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDfYIlqIYV4KWtIW7oL6UKcjPnXZid3WmlZqhRhpV90mwIgK21yaAJNYjNyS99GOQQkFhHo53QCcSChywSC%2B7Ob9cwqiAQIjP%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARAAGgw2Mzc0MjMxODM4MDUiDH2sOvQxJR1QVQCFyyrcA%2F9MRhVR8H4jFTiBPQGdtTpa%2B0CDLJR3M9bLraE7HjjRKVVOG7CglWfC7E9CQdhbm1q4c6pOm1PaadxBl2VVOyfWEdAeZT8D30UcmQCculkiO2%2Bh5qTBVpH57ZqXN1VT3QE62jJEAarE7EtQnk5MEe%2FMGkWXV7q8VEk4AHR0SC4KrzKsgQccZ3p%2FcDdjNHKpZmfD9hmVjjz9pLV5E5%2FkyLqhjFt%2FCzpzd%2Fb0oM1kQ6s%2BQXrcT6lSRD%2FjcUHDeN6zDEK%2Br3KCjEp3IslKiK1oLhwl4ZNTZZeUXp%2FBTwVkCozbquXo2BJk8Yi7i3bo731uGD996BlC6tjPFH9xci1R0omFEqh2dpfH6%2BKSHtSQoZfSNcqat8dLUtl3jCqEai4D88DjxtZueLCNXgE0NoXGLA8HA6TLjhWWW6f7jMa67z%2FDghQ2WSDwONOPcc6wi3BQWrNM8DDzWj4o3UiT%2BnNs2B35FENISfCUgvQdLts4dgLqeKZRkMlFHhhrwWACwfdlWwzwHwRYzeu7%2F6gA67WFh%2FgUDaPVAnfLvi1aawxxngbTqhCqfhsBwG9%2FYuqB7MpNy2WzuRKpp%2BlmocTXiQ5xemCc4hfCSpOaoz8Dnro%2BfL5hCdC4sBZnXIBB5PCHMNC%2F1ckGOqUBsQ27tN6vddoJMphAa4Ui1lxy81ggxcJ7Nv4gYUSGBU4WYwm%2Fy4F2IwpOZLxUz%2BvUKFVkoQ2ARQouYQBvtyZpwxMoYkep3s2Ofe1NDKtXYM8yJT0A8TN5DxJTRbhDuiqr3EyLgjZ1EtMeO1Ge97mStK5JqB4YnyTbiN8dF4z1Ef%2BkFYQPdFkvKmYW%2Fb5Qcd0T1EfkZ8nzr2XfQY2GQCm8PjyzKToi&X-Amz-Signature=08ebef1bd3c19034a1e00dd4f5d568030a85904861a988dfdae5f9f6975b2358&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)





- **Preview**:

![](https://prod-files-secure.s3.us-west-2.amazonaws.com/7a8a68e8-5855-41f2-ae17-565ecdbd6218/d8cf6e17-63f7-4ebd-885b-f9a7cc04099b/Screenshot_2025-08-09_at_12.57.09_PM.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Credential=ASIAZI2LB466SBUHKSOD%2F20251207%2Fus-west-2%2Fs3%2Faws4_request&X-Amz-Date=20251207T135310Z&X-Amz-Expires=3600&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEMP%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLXdlc3QtMiJHMEUCIQDfYIlqIYV4KWtIW7oL6UKcjPnXZid3WmlZqhRhpV90mwIgK21yaAJNYjNyS99GOQQkFhHo53QCcSChywSC%2B7Ob9cwqiAQIjP%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FARAAGgw2Mzc0MjMxODM4MDUiDH2sOvQxJR1QVQCFyyrcA%2F9MRhVR8H4jFTiBPQGdtTpa%2B0CDLJR3M9bLraE7HjjRKVVOG7CglWfC7E9CQdhbm1q4c6pOm1PaadxBl2VVOyfWEdAeZT8D30UcmQCculkiO2%2Bh5qTBVpH57ZqXN1VT3QE62jJEAarE7EtQnk5MEe%2FMGkWXV7q8VEk4AHR0SC4KrzKsgQccZ3p%2FcDdjNHKpZmfD9hmVjjz9pLV5E5%2FkyLqhjFt%2FCzpzd%2Fb0oM1kQ6s%2BQXrcT6lSRD%2FjcUHDeN6zDEK%2Br3KCjEp3IslKiK1oLhwl4ZNTZZeUXp%2FBTwVkCozbquXo2BJk8Yi7i3bo731uGD996BlC6tjPFH9xci1R0omFEqh2dpfH6%2BKSHtSQoZfSNcqat8dLUtl3jCqEai4D88DjxtZueLCNXgE0NoXGLA8HA6TLjhWWW6f7jMa67z%2FDghQ2WSDwONOPcc6wi3BQWrNM8DDzWj4o3UiT%2BnNs2B35FENISfCUgvQdLts4dgLqeKZRkMlFHhhrwWACwfdlWwzwHwRYzeu7%2F6gA67WFh%2FgUDaPVAnfLvi1aawxxngbTqhCqfhsBwG9%2FYuqB7MpNy2WzuRKpp%2BlmocTXiQ5xemCc4hfCSpOaoz8Dnro%2BfL5hCdC4sBZnXIBB5PCHMNC%2F1ckGOqUBsQ27tN6vddoJMphAa4Ui1lxy81ggxcJ7Nv4gYUSGBU4WYwm%2Fy4F2IwpOZLxUz%2BvUKFVkoQ2ARQouYQBvtyZpwxMoYkep3s2Ofe1NDKtXYM8yJT0A8TN5DxJTRbhDuiqr3EyLgjZ1EtMeO1Ge97mStK5JqB4YnyTbiN8dF4z1Ef%2BkFYQPdFkvKmYW%2Fb5Qcd0T1EfkZ8nzr2XfQY2GQCm8PjyzKToi&X-Amz-Signature=1f0628b2ce3d454abce336c2067b7de74ca45e8f924b73d020eba0b0269120ce&X-Amz-SignedHeaders=host&x-amz-checksum-mode=ENABLED&x-id=GetObject)






Observation:



Docling failed to capture equations cleanly and consistently (see PDF vs MD vs Preview placeholders above).



---


## OCR vs Hybrid Test

- **Sample size**: 20 PDFs (out of ~7,000; proper statistical sample = 168).
- **Word Extraction**:
    - Hybrid: 161,419 words
    - Forced OCR: 161,242 words
    - Δ = -177 words (-0.1%)
- **Processing Time**:
    - Hybrid: 476.8s
    - Forced OCR: 843.5s
    - Δ = +366.7s (+76.9%)
- **Table Detection**:
    - Hybrid: 537
    - Forced OCR: 538

Conclusion:



Similar extraction (<5% diff). Hybrid is faster and simpler.



<image placeholder - OCR vs Hybrid results chart>



---


## Metadata Quality Issue

- Marker JSON output must be **clean** (title, DOI, authors).
- Example problem: incorrect DOI/title impacts downstream embeddings + knowledge trees.

Example Output:



```javascript
{
"original_file": "(2)2021_park_aa452_dup1.pdf",
"conversion_date": "2025-08-08T21:45:58.754233",
"converter": "marker",
"metadata": {
"title": "and from the same link in the online table of contents at](https://academic.oup.com/jn/) https: //academic.oup.com/jn",
"authors": "Abbreviations used: BP, blood pressure; CKD, chronic kidney disease; eGFR, estimated glomerular filtration rate; GWAS, genome-wide association study; MR, Mendelian randomization; PGS, polygenic score; SNP, single-nucleotide polymorphism.",
"doi": "10.1093/jn/nxaa452.",
"keywords": "estimated glomerular filtration rate, Mendelian randomization, chronic kidney disease, diet, vegetable"
},
"content": {
"markdown": "TEXT",
"text_length": 57905
}
}
```






---


## Results Before Improvements (20 PDFs)


```javascript
MetricBeforeAfterImprovementAuthor Extraction22.2%100%+351%Complete Metadata¹16.7%94.7%+467%Processing Speed26.0 sec/PDF20.2 sec/PDF22% fasterDOI Extraction72.2%94.7%+31%
```


HYBRID_DEFAULT:


- Success: 18/20
- Metadata complete: 16.7%
- Authors extracted: 22.2%
- Titles: 100%
- DOIs: 72.2%

FORCE_OCR:


- Metadata complete: 5.6%
- Authors extracted: 16.7%

---


## Results After Improvements (20 PDFs)


<image placeholder - Metadata results AFTER>



HYBRID_DEFAULT:


- Success: 19/20
- Metadata complete: 94.7%
- Authors extracted: 100%
- Titles: 100%
- DOIs: 94.7%

FORCE_OCR:


- Same metadata rates as Hybrid after improvements.

---


## Metadata Extraction Improvement - Approach


<image placeholder - Cascade approach diagram>


- **Cascade strategy (5 steps)**:
    1. Basic regex patterns
    2. Search near found title
    3. Header scan
    4. Citation format parsing
    5. Last resort: direct PDF object extraction (PyMuPDF)
- **Enhancements**:
    - Expanded search windows (15K → 25K chars)
    - Multiple regex sets: 8 (titles), 15 (authors), 6 (DOIs)
    - Proximity search within 2,000 chars of title
    - DOI search across full doc
    - SequenceMatcher for fuzzy title match
    - Jaccard index for author sets
    - Normalized separators; cleaned superscripts/affiliations/emails

---


## Impact at Scale (n=6,841 UKB Papers)


<image placeholder - Before vs After coverage chart>


- **Before**: ~1,143 papers complete metadata
- **After**: ~6,479 papers complete metadata
- **Gain**: +5,336 searchable papers (↑78% coverage)
- Faster due to fail-fast logic (skip extra steps if early match found)

---


## Limitation

- Sample size (n=50 in later test) not enough for p<0.05 certainty (need n≥168).
- However, improvement magnitude (22% → 100%) suggests strong real-world performance.








